//RelatÃ³rio Geral-Notas Emitidas                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
sap.ui.define([                                                                                                                                                                                                                                                
	'sap/ui/core/util/Export',                                                                                                                                                                                                                                    
	'sap/ui/core/util/ExportTypeCSV',                                                                                                                                                                                                                             
	"sap/ui/model/Filter",                                                                                                                                                                                                                                        
	"sap/ui/model/FilterOperator",                                                                                                                                                                                                                                
    "sap/ui/model/json/JSONModel"                                                                                                                                                                                                                              
],	                                                                                                                                                                                                                                                            
	function (Export,ExportTypeCSV,Filter,FilterOperator,JSONModel) {                                                                                                                                                                                             
		"use strict";                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
        let API = {                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
            OC: null,                                                                                                                                                                                                                                          
            oView: null,                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
            localFull: {},                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
            Export: function (iOC,iView) {                                                                                                                                                                                                                     
                this.OC = iOC;                                                                                                                                                                                                                                 
                this.oView = iView;                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                iView.setBusy(true);                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
                this._fetchFull().then(                                                                                                                                                                                                                        
                    this._enrichIt.bind(this),  //resolve                                                                                                                                                                                                      
                    (error)=>{                  //reject                                                                                                                                                                                                       
                        debugger;                                                                                                                                                                                                                              
                    }                                                                                                                                                                                                                                          
                ).then(this._exportIt.bind(this));                                                                                                                                                                                                             
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            _fetchFull: async function() {                                                                                                                                                                                                                     
                var aLocalShort = this.OC.getModel("localShort");                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                var defaultModel = this.OC.getModel();                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                var aFilters = _buildFilters(aLocalShort);                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                //fetch the full data                                                                                                                                                                                                                          
                return new Promise(                                                                                                                                                                                                                            
                    (resolve,reject)=>{                                                                                                                                                                                                                        
                        defaultModel.read(                                                                                                                                                                                                                     
                            "/eDocXls1",                                                                                                                                                                                                                       
                            {                                                                                                                                                                                                                                  
                                urlParameters: {                                                                                                                                                                                                               
                                    "$expand": "to_xml,to_Items,to_xml/to_Items",                                                                                                                                                                              
                                    "$top": "20000"                                                                                                                                                                                                            
                                },                                                                                                                                                                                                                             
                                filters: aFilters,                                                                                                                                                                                                             
                                success: (oData)=>{resolve(oData)},                                                                                                                                                                                            
                                error: (error)=>{reject(error)}                                                                                                                                                                                                
                            }                                                                                                                                                                                                                                  
                        );&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                             
                    }                                                                                                                                                                                                                                          
                );                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
                function _buildFilters(aShort) {                                                                                                                                                                                                               
                    var aFilters = [];                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                    aShort.forEach((oShort)=>{                                                                                                                                                                                                                 
                        var oFilter = new Filter(                                                                                                                                                                                                              
                            "Accesskey",                                                                                                                                                                                                                       
                            FilterOperator.EQ,                                                                                                                                                                                                                 
                            oShort.Accesskey                                                                                                                                                                                                                   
                        );&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                     
                        aFilters.push(oFilter);                                                                                                                                                                                                                
                    });                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                    aFilters.push(                                                                                                                                                                                                                             
                        new Filter(                                                                                                                                                                                                                            
                            "Status",                                                                                                                                                                                                                          
                            FilterOperator.NE,                                                                                                                                                                                                                 
                            "8"                                                                                                                                                                                                                                
                        )                                                                                                                                                                                                                                      
                    );                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                    return aFilters;                                                                                                                                                                                                                           
                }                                                                                                                                                                                                                                              
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            _enrichIt: function(oData) {                                                                                                                                                                                                                       
                // oData.results = oData.results.filter(v => v.to_xml.StatusValid !== "C");&nbsp;                                                                                                                                                              
                // este filtro nÃ£o estÃ¡ fazendo efeito jÃ¡ que notas canceladas tbm tem status ctrl = '8'&nbsp;                                                                                                                                                 
                // e estas nem sÃ£o trazidas do backend                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                var aRich = oData.results.map((oFull)=>{                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                    var oRich = oFull;                                                                                                                                                                                                                         
                    //Items                                                                                                                                                                                                                                    
                    if (oFull.to_xml&&oFull.to_xml.to_Items) {                                                                                                                                                                                                 
                        var aXPed = [];                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                        oFull.to_xml.to_Items.results.forEach((item)=>{                                                                                                                                                                                        
                            if (aXPed.includes(item.XPed)) {                                                                                                                                                                                                   
                                //return;                                                                                                                                                                                                                      
                            } else {                                                                                                                                                                                                                           
                                aXPed.push(item.XPed);                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                                //Pedidos                                                                                                                                                                                                                      
                                oRich.Pedidos =&nbsp;                                                                                                                                                                                                          
                                        ( oRich.Pedidos ? oRich.Pedidos + "/" : "" )&nbsp;                                                                                                                                                                     
                                    +   item.XPed;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                           
                            }                                                                                                                                                                                                                                  
                        });                                                                                                                                                                                                                                    
                    }                                                                                                                                                                                                                                          
                    //ItemsFull                                                                                                                                                                                                                                
                    if (oFull.to_Items) {                                                                                                                                                                                                                      
                        var aCfop = [];&nbsp;                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                        oFull.to_Items.results.forEach((item)=>{                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                            if (aCfop.includes(item.Cfop)) {                                                                                                                                                                                                   
                                //return;                                                                                                                                                                                                                      
                            } else {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                         
                                aCfop.push(item.Cfop);&nbsp;                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                                //Pedidos                                                                                                                                                                                                                      
                                oRich.Cfop = ( oRich.Cfop ? oRich.Cfop + "/" : "" )  + item.Cfop;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&+
nbsp;                                                                                                                                                                                                                                                          
                            }                                                                                                                                                                                                                                  
                        });                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                    }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                  
                                                                                                                                                                                                                                                               
                    //Divergencies                                                                                                                                                                                                                             
                    if (oFull.to_xml) { //if there is no xml (transaction) then itÂ´s undefined                                                                                                                                                                 
                        oRich.Divergencias =&nbsp;                                                                                                                                                                                                             
                            (oFull.to_xml.Divergencias)                                                                                                                                                                                                        
                            ? "Sim"                                                                                                                                                                                                                            
                            : "NÃ£o";                                                                                                                                                                                                                           
                    } else {                                                                                                                                                                                                                                   
                        oRich.Divergencias = "NÃ£o";                                                                                                                                                                                                            
                    }                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                    //                                                                                                                                                                                                                                         
                    return oRich;                                                                                                                                                                                                                              
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                return aRich;                                                                                                                                                                                                                                  
            },                                                                                                                                                                                                                                                 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                           
            _exportIt(oData) {                                                                                                                                                                                                                                 
                //sample do UI5                                                                                                                                                                                                                                
                // https://sapui5.hana.ondemand.com/#/entity/sap.m.Table/sample/sap.m.sample.TableExport                                                                                                                                                       
                                                                                                                                                                                                                                                               
                var oModel = new JSONModel(oData);                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
                var oExport = new Export({                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                    // Type that will be used to generate the content. Own ExportType's can be created to support other formats                                                                                                                                
                    exportType : new ExportTypeCSV({                                                                                                                                                                                                           
                        separatorChar : ";"                                                                                                                                                                                                                    
                    }),                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                    // Pass in the model created above                                                                                                                                                                                                         
                    models : oModel,                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
                    // binding information for the rows aggregation                                                                                                                                                                                            
                    rows : {                                                                                                                                                                                                                                   
                        path : "/"                                                                                                                                                                                                                             
                    },                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                    // column definitions with column name and binding info for the content                                                                                                                                                                    
                    columns : [                                                                                                                                                                                                                                
                        {                                                                                                                                                                                                                                      
                            name : "Status Controle",                                                                                                                                                                                                          
                            template : {                                                                                                                                                                                                                       
                                content : {                                                                                                                                                                                                                    
                                    parts: ["Status"],                                                                                                                                                                                                         
                                    formatter : function(status) {                                                                                                                                                                                             
                                        if (!status) return;                                                                                                                                                                                                   
                                        switch(status) {                                                                                                                                                                                                       
                                            case "0": return "Indefinido";                                                                                                                                                                                     
                                            case "1": return "Liberado";                                                                                                                                                                                       
                                            case "2": return "Arquivado";                                                                                                                                                                                      
                                            case "3": return "Desfeito";                                                                                                                                                                                       
                                            case "9": return "Rejeitado";                                                                                                                                                                                      
                                            default: return "Indefinido";                                                                                                                                                                                      
                                        }                                                                                                                                                                                                                      
                                    }                                                                                                                                                                                                                          
                                }&nbsp;                                                                                                                                                                                                                        
                            }                                                                                                                                                                                                                                  
                        },                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        {                                                                                                                                                                                                                                      
                            name : "MÃªs de EmissÃ£o",                                                                                                                                                                                                           
                            template : {                                                                                                                                                                                                                       
                                content : {                                                                                                                                                                                                                    
                                    parts : ["InfnfeIdeDhemi"],                                                                                                                                                                                                
                                    formatter : function(dtIn) {                                                                                                                                                                                               
                                        if (!dtIn) return;                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                                        var dtOut = dtIn.substr(3,2);                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                                        switch(dtOut) {                                                                                                                                                                                                        
                                            case "01": return "Janeiro";                                                                                                                                                                                       
                                            case "02": return "Fevereiro";                                                                                                                                                                                     
                                            case "03": return "MarÃ§o";                                                                                                                                                                                         
                                            case "04": return "Abril";                                                                                                                                                                                         
                                            case "05": return "Maio";                                                                                                                                                                                          
                                            case "06": return "Junho";                                                                                                                                                                                         
                                            case "07": return "Julho";                                                                                                                                                                                         
                                            case "08": return "Agosto";                                                                                                                                                                                        
                                            case "09": return "Setembro";                                                                                                                                                                                      
                                            case "10": return "Outubro";                                                                                                                                                                                       
                                            case "11": return "Novembro";                                                                                                                                                                                      
                                            case "12": return "Dezembro";                                                                                                                                                                                      
                                        }                                                                                                                                                                                                                      
                                    }                                                                                                                                                                                                                          
                                }	                                                                                                                                                                                                                             
                            }                                                                                                                                                                                                                                  
                        },                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        {                                                                                                                                                                                                                                      
                            name : "Data de EmissÃ£o",                                                                                                                                                                                                          
                            template : {                                                                                                                                                                                                                       
                                content : "{InfnfeIdeDhemi}"                                                                                                                                                                                                   
                            }                                                                                                                                                                                                                                  
                        },                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        {                                                                                                                                                                                                                                      
                            name : "NÃºmero da Nfe",                                                                                                                                                                                                            
                            template : {                                                                                                                                                                                                                       
                                content : "{Nfenum}"                                                                                                                                                                                                           
                            }                                                                                                                                                                                                                                  
                        },                                                                                                                                                                                                                                     
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                               
                        {                                                                                                                                                                                                                                      
                            name : "Chave de Acesso",                                                                                                                                                                                                          
                            template : {                                                                                                                                                                                                                       
                                content : {                                                                                                                                                                                                                    
                                    parts : ["Accesskey"],                                                                                                                                                                                                     
                                    formatter : function(accessKey) {                                                                                                                                                                                          
                                        if (!accessKey) return;                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
                                        return "'"+accessKey+"'";                                                                                                                                                                                              
                                    }                                                                                                                                                                                                                          
                                }	                                                                                                                                                                                                                             
                            }                                                                                                                                                                                                                                  
                        },                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        {                                                                                                                                                                                                                                      
                            name : "DivergÃªncia",                                                                                                                                                                                                              
                            template : {                                                                                                                                                                                                                       
                                content : "{Divergencias}"                                                                                                                                                                                                     
                            }                                                                                                                                                                                                                                  
                        },                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        {                                                                                                                                                                                                                                      
                            name : "Valor Nfe",                                                                                                                                                                                                                
                            template : {                                                                                                                                                                                                                       
                                content :&nbsp;                                                                                                                                                                                                                
                                {&nbsp;                                                                                                                                                                                                                        
                                    parts :&nbsp;                                                                                                                                                                                                              
                                        [                                                                                                                                                                                                                      
                                            { path:'InfNFeTotalIcmstotVnf'}                                                                                                                                                                                    
                                          //  { path:'Currency'}                                                                                                                                                                                               
                                        ],                                                                                                                                                                                                                     
                                    type:'sap.ui.model.type.Currency',                                                                                                                                                                                         
                                    formatOptions: {                                                                                                                                                                                                           
                                        showMeasure: true                                                                                                                                                                                                      
                                    }                                                                                                                                                                                                                          
                                }                                                                                                                                                                                                                              
                            }                                                                                                                                                                                                                                  
                        },                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        {                                                                                                                                                                                                                                      
                            name : "Data de Vencimento",                                                                                                                                                                                                       
                            template : {                                                                                                                                                                                                                       
                                content : "{InfnfeCobrDupDvenc}"                                                                                                                                                                                               
                            }                                                                                                                                                                                                                                  
                        },                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        {                                                                                                                                                                                                                                      
                            name : "Tipo NFe",                                                                                                                                                                                                                 
                            template : {                                                                                                                                                                                                                       
                                content : {                                                                                                                                                                                                                    
                                    parts : ["InfnfeIdeTpnf"],                                                                                                                                                                                                 
                                    formatter : function(tp) {                                                                                                                                                                                                 
                                        if (!tp) return;                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                                        switch (tp) {                                                                                                                                                                                                          
                                            case "0": return "0 - Entrada";                                                                                                                                                                                    
                                            case "1": return "1 - SaÃ­da";                                                                                                                                                                                      
                                        }                                                                                                                                                                                                                      
                                    }                                                                                                                                                                                                                          
                                }	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                             
                            }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                          
                        },                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        {                                                                                                                                                                                                                                      
                            name : "Finalidade",                                                                                                                                                                                                               
                            template : {                                                                                                                                                                                                                       
                                content : {                                                                                                                                                                                                                    
                                    parts : ["InfnfeIdeFinnfe"],                                                                                                                                                                                               
                                    formatter : function(fin) {                                                                                                                                                                                                
                                        if (!fin) return;                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                                        switch (fin) {                                                                                                                                                                                                         
                                            case "1": return "1 - Normal";                                                                                                                                                                                     
                                            case "2": return "2 - Complementar";                                                                                                                                                                               
                                            case "3": return "3 - NF-e de ajuste";                                                                                                                                                                             
                                            case "4": return "4 - DevoluÃ§Ã£o de Mercadoria";                                                                                                                                                                    
                                        }                                                                                                                                                                                                                      
                                    }                                                                                                                                                                                                                          
                                }	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                             
                            }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                          
                        },                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        {                                                                                                                                                                                                                                      
                            name : "Natureza da OperaÃ§Ã£o",                                                                                                                                                                                                     
                            template : {                                                                                                                                                                                                                       
                                content : "{InfnfeIdeNatOp}"                                                                                                                                                                                                   
                            }                                                                                                                                                                                                                                  
                        },                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        {                                                                                                                                                                                                                                      
                            name : "CFOP",                                                                                                                                                                                                                     
                            template : {                                                                                                                                                                                                                       
                                content : "{Cfop}"                                                                                                                                                                                                             
                            }                                                                                                                                                                                                                                  
                        },&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                     
                                                                                                                                                                                                                                                               
                        {                                                                                                                                                                                                                                      
                            name : "Pin",                                                                                                                                                                                                                      
                            template : {                                                                                                                                                                                                                       
                                content : {                                                                                                                                                                                                                    
                                    parts : ["to_xml/Pin"],                                                                                                                                                                                                    
                                    formatter : function(pin) {                                                                                                                                                                                                
                                        if (!pin) return "Indefinido";                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                                        switch (pin) {                                                                                                                                                                                                         
                                            case "0": return "Indefinido";                                                                                                                                                                                     
                                            case "1": return "NÃ£o Necessita Pin";                                                                                                                                                                              
                                            case "2": return "Analisar";                                                                                                                                                                                       
                                            case "3": return "Necessita Pin";                                                                                                                                                                                  
                                            case "4": return "Pin Aceito";                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                                            default : return "Indefinido";                                                                                                                                                                                     
                                        }                                                                                                                                                                                                                      
                                    }                                                                                                                                                                                                                          
                                }	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                             
                            }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                
                        },                                                                                                                                                                                                                                     
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                   
                        {                                                                                                                                                                                                                                      
                            name : "NÃºmero da Nfe de ReferÃªncia",                                                                                                                                                                                              
                            template : {                                                                                                                                                                                                                       
                                content : "{InfnfeIdeNfrefNnf}"                                                                                                                                                                                                
                            }                                                                                                                                                                                                                                  
                        },                                                                                                                                                                                                                                     
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                               
                        {                                                                                                                                                                                                                                      
                            name : "Chave de Acesso Nfe de ReferÃªncia",                                                                                                                                                                                        
                            template : {                                                                                                                                                                                                                       
                                content : {                                                                                                                                                                                                                    
                                    parts : ["InfnfeIdeNfrefRefnfe"],                                                                                                                                                                                          
                                    formatter : function(accessKey) {                                                                                                                                                                                          
                                        if (!accessKey) return;                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
                                        return "'"+accessKey+"'";                                                                                                                                                                                              
                                    }                                                                                                                                                                                                                          
                                }	                                                                                                                                                                                                                             
                            }                                                                                                                                                                                                                                  
                        },                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        {                                                                                                                                                                                                                                      
                            name : "Comprador(a)",                                                                                                                                                                                                             
                            template : {                                                                                                                                                                                                                       
                                content : "{EkkoUserName}"                                                                                                                                                                                                     
                            }                                                                                                                                                                                                                                  
                        },                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        {                                                                                                                                                                                                                                      
                            name : "Pedido/Programa",                                                                                                                                                                                                          
                            template : {                                                                                                                                                                                                                       
                                content : "{Pedidos}"                                                                                                                                                                                                          
                            }                                                                                                                                                                                                                                  
                        },                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        {                                                                                                                                                                                                                                      
                            name : "UF Emitente",                                                                                                                                                                                                              
                            template : {                                                                                                                                                                                                                       
                                content : "{InfnfeEmitEnderemitUf}"                                                                                                                                                                                            
                            }                                                                                                                                                                                                                                  
                        },                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        {                                                                                                                                                                                                                                      
                            name : "CNPJ do Emitente",                                                                                                                                                                                                         
                            template : {                                                                                                                                                                                                                       
                                content : {                                                                                                                                                                                                                    
                                    parts : ["InfnfeEmitCnpj"],                                                                                                                                                                                                
                                    formatter : function(cnpj) {                                                                                                                                                                                               
                                        if (!cnpj) return;                                                                                                                                                                                                     
                                        return cnpj.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/g,"\$1.\$2.\$3\/\$4\-\$5");                                                                                                                                   
                                    }                                                                                                                                                                                                                          
                                }	                                                                                                                                                                                                                             
                            }                                                                                                                                                                                                                                  
                        },                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        {                                                                                                                                                                                                                                      
                            name : "Emitente",                                                                                                                                                                                                                 
                            template : {                                                                                                                                                                                                                       
                                content : "{InfnfeEmitXnome}"                                                                                                                                                                                                  
                            }                                                                                                                                                                                                                                  
                        },                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        {                                                                                                                                                                                                                                      
                            name : "CNPJ do DestinatÃ¡rio",                                                                                                                                                                                                     
                            template : {                                                                                                                                                                                                                       
                                content : {                                                                                                                                                                                                                    
                                    parts : ["InfnfeDestCnpj"],                                                                                                                                                                                                
                                    formatter : function(cnpj) {                                                                                                                                                                                               
                                        if (!cnpj) return;                                                                                                                                                                                                     
                                        return cnpj.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/g,"\$1.\$2.\$3\/\$4\-\$5");                                                                                                                                   
                                    }                                                                                                                                                                                                                          
                                }	                                                                                                                                                                                                                             
                            }                                                                                                                                                                                                                                  
                        },                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        {                                                                                                                                                                                                                                      
                            name : "DestinatÃ¡rio",                                                                                                                                                                                                             
                            template : {                                                                                                                                                                                                                       
                                content : "{InfnfeDestXnome}"                                                                                                                                                                                                  
                            }                                                                                                                                                                                                                                  
                        },                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        {                                                                                                                                                                                                                                      
                            name : "InscriÃ§Ã£o Estadual do DestinatÃ¡rio",                                                                                                                                                                                       
                            template : {                                                                                                                                                                                                                       
                                content : {                                                                                                                                                                                                                    
                                    parts : ["InfnfeDestIe"],                                                                                                                                                                                                  
                                    formatter : function(infnfeDestIe) {                                                                                                                                                                                       
                                        if (!infnfeDestIe) return;                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
                                        return "'"+infnfeDestIe+"'";                                                                                                                                                                                           
                                    }                                                                                                                                                                                                                          
                                }                                                                                                                                                                                                                              
                            }                                                                                                                                                                                                                                  
                        },                                                                                                                                                                                                                                     
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                               
                        {                                                                                                                                                                                                                                      
                            name : "InscriÃ§Ã£o Suframa do DestinatÃ¡rio",                                                                                                                                                                                        
                            template : {                                                                                                                                                                                                                       
                                content : "{InfnfeDestEnderDestIsuf}"                                                                                                                                                                                          
                            }                                                                                                                                                                                                                                  
                        },                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        {                                                                                                                                                                                                                                      
                            name : "Modalidade do Frete + DescriÃ§Ã£o",                                                                                                                                                                                          
                            template : {                                                                                                                                                                                                                       
                                content : {                                                                                                                                                                                                                    
                                    parts : ["InfnfeTranspModFrete"],                                                                                                                                                                                          
                                    formatter : function(mf) {                                                                                                                                                                                                 
                                        if (!mf) return;                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                                        switch (mf) {                                                                                                                                                                                                          
                                            case "0": return "0 - ContrataÃ§Ã£o do Frete por conta do Remetente (CIF)";                                                                                                                                          
                                            case "1": return "1 - ContrataÃ§Ã£o do Frete por conta do DestinatÃ¡rio (FOB)";                                                                                                                                       
                                            case "2": return "2 - ContrataÃ§Ã£o do Frete por conta de Terceiros";                                                                                                                                                
                                            case "3": return "3 - Transporte PrÃ³prio por conta do Remetente";                                                                                                                                                  
                                            case "4": return "4 - Transporte PrÃ³prio por conta do DestinatÃ¡rio";                                                                                                                                               
                                            case "9": return "9 - Sem OcorrÃªncia de Transporte";	                                                                                                                                                              
                                            default: return "";                                                                                                                                                                                                
                                        }                                                                                                                                                                                                                      
                                    }                                                                                                                                                                                                                          
                                }	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                             
                            }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                
                        },                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        {                                                                                                                                                                                                                                      
                            name : "CNPJ da Transportadora",                                                                                                                                                                                                   
                            template : {                                                                                                                                                                                                                       
                                content : {                                                                                                                                                                                                                    
                                    parts : ["InfnfeTranspTransportaCnpj"],                                                                                                                                                                                    
                                    formatter : function(cnpj) {                                                                                                                                                                                               
                                        if (!cnpj) return;                                                                                                                                                                                                     
                                        return cnpj.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/g,"\$1.\$2.\$3\/\$4\-\$5");                                                                                                                                   
                                    }                                                                                                                                                                                                                          
                                }	                                                                                                                                                                                                                             
                            }                                                                                                                                                                                                                                  
                        },                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        {                                                                                                                                                                                                                                      
                            name : "Nome Transportadora",                                                                                                                                                                                                      
                            template : {                                                                                                                                                                                                                       
                                content : "{InfnfeTranspTransportaXnome}"                                                                                                                                                                                      
                            }                                                                                                                                                                                                                                  
                        }                                                                                                                                                                                                                                      
                    ]                                                                                                                                                                                                                                          
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                // download exported file                                                                                                                                                                                                                      
                oExport.saveFile().catch(function(oError) {                                                                                                                                                                                                    
                    MessageBox.error(                                                                                                                                                                                                                          
                        //this.getView().getModel("i18n").getResourceBundle().getText("DataExportError")                                                                                                                                                       
                        "Error when downloading data. Browser might not be supported!"                                                                                                                                                                         
                        +"\n\n"&nbsp;                                                                                                                                                                                                                          
                        + oError);                                                                                                                                                                                                                             
                }).then(function() {                                                                                                                                                                                                                           
                    oExport.destroy();                                                                                                                                                                                                                         
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                this.oView.setBusy(false);                                                                                                                                                                                                                     
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
			getI18nText: function(key) {                                                                                                                                                                                                                                
				return this.OC.getModel("i18n").getResourceBundle().getText(key);                                                                                                                                                                                          
			}                                                                                                                                                                                                                                                           
        } // API                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
        return API.Export.bind(API);                                                                                                                                                                                                                           
    }                                                                                                                                                                                                                                                          
)                                                                                                                                                                                                                                                              