sap.ui.define([                                                                                                                                                                                                                                                
	"sap/m/MessageBox",&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                   
    "sap/m/MessageToast",                                                                                                                                                                                                                                      
	"sap/ui/model/resource/ResourceModel",                                                                                                                                                                                                                        
	"umicore/mm/nfevalid/zmmnfevalid/controller/Base.controller",                                                                                                                                                                                                 
    "umicore/mm/nfevalid/zmmnfevalid/controller/Message",                                                                                                                                                                                                      
    "umicore/mm/nfevalid/zmmnfevalid/controller/Divergences",                                                                                                                                                                                                  
    "umicore/mm/nfevalid/zmmnfevalid/controller/DivergencesShow",                                                                                                                                                                                              
    "umicore/mm/nfevalid/zmmnfevalid/controller/ContentViewer",                                                                                                                                                                                                
    "umicore/mm/nfevalid/zmmnfevalid/model/formatter",                                                                                                                                                                                                         
    "umicore/mm/nfevalid/zmmnfevalid/controller/NfWriteMsgs"                                                                                                                                                                                                   
],                                                                                                                                                                                                                                                             
	function (MessageBox,MessageToast,ResourceModel,Controller,Message,Divergences,DivergencesShow,ContentViewer,formatter,NfWriteMsgs) {                                                                                                                         
		"use strict";                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
		return Controller.extend("umicore.mm.nfevalid.zmmnfevalid.controller.Object", {                                                                                                                                                                              
            //globals                                                                                                                                                                                                                                          
            formatter: formatter,                                                                                                                                                                                                                              
            oListView: null, //list view controller reference                                                                                                                                                                                                  
            action: null,                                                                                                                                                                                                                                      
            selItem: null,&nbsp;                                                                                                                                                                                                                               
            oView: null,                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
			onInit: function () {                                                                                                                                                                                                                                       
				//this.sayHello("from Object Page");                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                var oRouter = this.getRouter();                                                                                                                                                                                                                
                oRouter.getRoute("RouteObject").attachMatched(this.onRouteMatched, this);                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                //global model                                                                                                                                                                                                                                 
                this.getView().setModel(this.getGlobalModel(),"global");&nbsp;                                                                                                                                                                                 
                //let oModel = this.getView().getModel("global");&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                          
                                                                                                                                                                                                                                                               
                //keep list view reference                                                                                                                                                                                                                     
                var oGlobalModelData = this.getGlobalModel().getData();                                                                                                                                                                                        
                this.oListView = oGlobalModelData.oListView;                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                //local model                                                                                                                                                                                                                                  
                var local = new sap.ui.model.json.JSONModel(                                                                                                                                                                                                   
                    {                                                                                                                                                                                                                                          
                        errorsTitle: "",                                                                                                                                                                                                                       
                        oView: this.getView()                                                                                                                                                                                                                  
                    }                                                                                                                                                                                                                                          
                );                                                                                                                                                                                                                                             
                this.getView().setModel(local,"local");                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
				// set i18n model on view                                                                                                                                                                                                                                  
				var i18nModel = new ResourceModel({                                                                                                                                                                                                                        
					bundleName: "umicore.mm.nfevalid.zmmnfevalid.i18n.i18n"                                                                                                                                                                                                   
				});                                                                                                                                                                                                                                                        
				this.getView().setModel(i18nModel, "i18n");                                                                                                                                                                                                                
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onRouteMatched: function(oEvent) {                                                                                                                                                                                                                 
                this.ctxSetup();                                                                                                                                                                                                                               
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            ctxSetupForTest: function() {                                                                                                                                                                                                                      
                console.log("Teste mode");                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                this.bindIt(                                                                                                                                                                                                                                   
                    this.getView(),                                                                                                                                                                                                                            
                    //"/XML('13210904386041000119550010006817151150093722')" //véio de guerra                                                                                                                                                                  
                    //"/XML('13200584520956000104550010000000101567109468')" //é da empresa certa                                                                                                                                                              
                    //"/XML('35210961435970000104550020007095651100137280')" //tem xPed&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                            
                    //"/XML('13211104449252000153550010000013511485500857')" //tem xPed e é da empresa, SQN                                                                                                                                                    
                    //"/XML('35220300327149000341550000001197121001289867')" //XML zicado na hora do beautyfy                                                                                                                                                  
                    //"/XML('13220384512037000199550010000411431060411432')" //zica na lista de erros                                                                                                                                                          
                    //"/XML('13220307842762000184550030000178211100170348')" //programa de remessa                                                                                                                                                             
                    //"/XML('15220204207303000130550010000038631261346672')" //PO desonerado                                                                                                                                                                   
                    //"/XML('35220350918812000199550220000248911794677361')" //PO de 3 itens com IPI                                                                                                                                                           
                    //"/XML('13220384512037000199550010000413891060413893')" //tem nfe referencia                                                                                                                                                              
                    "/XML('35220232531364000194550010000009601863159467')" //NF Write                                                                                                                                                                          
                );&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                             
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            ctxSetup: function() {                                                                                                                                                                                                                             
//bind the incoming instance                                                                                                                                                                                                                                   
                this.getView().setBusy(true);                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                var globalModelData = this.getGlobalModel().getData();                                                                                                                                                                                         
                if (!globalModelData.listRow) {                                                                                                                                                                                                                
                    this.ctxSetupForTest();&nbsp;                                                                                                                                                                                                              
                    return;                                                                                                                                                                                                                                    
                }                                                                                                                                                                                                                                              
                var accessKey = globalModelData.listRow.oData.Accesskey;                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                //setar a entry que navegou                                                                                                                                                                                                                    
                var sPath = globalModelData.listRow.sPath;                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                //resetar para XML (entidade transacional)                                                                                                                                                                                                     
                sPath = sPath.replace("eDoc","XML");                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
                //check if the row exists or not in the backend                                                                                                                                                                                                
                var that = this;                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                _checkIfExists(this.getView().getModel(),sPath).then(function(exists){                                                                                                                                                                         
                    //console.log("Exists="+exists);                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
                    if (exists) {                                                                                                                                                                                                                              
                        that.bindIt(that.getView(),sPath);                                                                                                                                                                                                     
                    }                                                                                                                                                                                                                                          
                    else {                                                                                                                                                                                                                                     
                        //must be created                                                                                                                                                                                                                      
                        that._create(that.getView().getModel(),accessKey).then(                                                                                                                                                                                
                            function(creationResult) {                                                                                                                                                                                                         
                                if (!creationResult) {                                                                                                                                                                                                         
                                    that.onNavBack();                                                                                                                                                                                                          
                                }                                                                                                                                                                                                                              
                                that.bindIt(that.getView(),sPath);                                                                                                                                                                                             
                            }                                                                                                                                                                                                                                  
                        );                                                                                                                                                                                                                                     
                    }                                                                                                                                                                                                                                          
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                //setting the errors table for binding to nothing                                                                                                                                                                                              
                //this.setErrorsTable(null,"");&nbsp;                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                //disable item´s details                                                                                                                                                                                                                       
                this.getView().byId("itemDetails").setVisible(false);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                          
                                                                                                                                                                                                                                                               
                //privates...                                                                                                                                                                                                                                  
                function _checkIfExists(oModel,iPath) {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                
                    var exists = false;                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                    return new Promise (                                                                                                                                                                                                                       
                        function(resolve, reject) {                                                                                                                                                                                                            
                            oModel.read(                                                                                                                                                                                                                       
                                iPath,                                                                                                                                                                                                                         
                                {                                                                                                                                                                                                                              
                                    success: function() {                                                                                                                                                                                                      
                                        exists = true;                                                                                                                                                                                                         
                                        resolve(exists);                                                                                                                                                                                                       
                                    },                                                                                                                                                                                                                         
                                    error: function() {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                          
                                        exists = false;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&+
nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                              
                                        resolve(exists);                                                                                                                                                                                                       
                                    }                                                                                                                                                                                                                          
                                }                                                                                                                                                                                                                              
                            );&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                         
                        }                                                                                                                                                                                                                                      
                    );                                                                                                                                                                                                                                         
                }                                                                                                                                                                                                                                              
            }, //ctxSetup                                                                                                                                                                                                                                      
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                               
            _create: function(oModel,accessKey) {                                                                                                                                                                                                              
                return new Promise(                                                                                                                                                                                                                            
                    function(resolve,reject) {                                                                                                                                                                                                                 
                        oModel.createEntry(                                                                                                                                                                                                                    
                            "XML",                                                                                                                                                                                                                             
                            {&nbsp;                                                                                                                                                                                                                            
                                properties:&nbsp;                                                                                                                                                                                                              
                                    {                                                                                                                                                                                                                          
                                        "Chave" : accessKey                                                                                                                                                                                                    
                                    }                                                                                                                                                                                                                          
                            }                                                                                                                                                                                                                                  
                        );                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        oModel.submitChanges({                                                                                                                                                                                                                 
                            success: function() {                                                                                                                                                                                                              
                                resolve(true);                                                                                                                                                                                                                 
                            },                                                                                                                                                                                                                                 
                            error: function() {                                                                                                                                                                                                                
                                debugger;                                                                                                                                                                                                                      
                                resolve(false);                                                                                                                                                                                                                
                            }                                                                                                                                                                                                                                  
                        });                                                                                                                                                                                                                                    
                    }                                                                                                                                                                                                                                          
                )                                                                                                                                                                                                                                              
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            bindIt: function(iView,iPath) {                                                                                                                                                                                                                    
                this.thePath = iPath; //keeping it as global                                                                                                                                                                                                   
                var oView2 = iView;                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                // bind element do XML na view                                                                                                                                                                                                                 
                iView.bindElement(                                                                                                                                                                                                                             
                    {                                                                                                                                                                                                                                          
                        path: iPath,                                                                                                                                                                                                                           
                        parameters: {                                                                                                                                                                                                                          
                            expand:   //...Very 'Eavy ...(not) Very 'Umble&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                               
                                "to_eDoc,to_Items,to_Cods,to_LastLogH,to_Errors,to_ObsH,"                                                                                                                                                                      
                            +   "to_Items/to_Errors,"                                                                                                                                                                                                          
                            +   "to_Items/to_Errors/to_Item,"                                                                                                                                                                                                  
                            //+   "to_Items/to_Errors/to_Header/to_eDoc,"                                                                                                                                                                                      
                            //+   "to_Items/to_Errors/to_Item/to_Header/to_eDoc," //this one is for the user to have the Nfenum on the error level...   O_o                                                                                                    
                            +   "to_Items/to_eDocIt,"                                                                                                                                                                                                          
                            +   "to_Items/to_LastLog,"                                                                                                                                                                                                         
                            +   "to_Items/to_Obs,"                                                                                                                                                                                                             
                            +   "to_Items/to_eDoc,"                                                                                                                                                                                                            
                            +   "to_Items/to_Header,"                                                                                                                                                                                                          
                            +   "to_Items/to_Header/to_eDoc"                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                            // Unfortunatly the end user has asked for some fields to show up at odd places such                                                                                                                                               
                            // as header attribs at item level, and the more serious case of the NfeNum (header)                                                                                                                                               
                            // at errors entity level, which is 2 levels in.                                                                                                                                                                                   
                            // These details are dragging the performance a bit (but it´s really a lot).                                                                                                                                                       
                        },                                                                                                                                                                                                                                     
                        events: {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                              
                            change: _dataReceivedAfterBind.bind(this),                                                                                                                                                                                         
                            dataRequested: function (oEvent) {                                                                                                                                                                                                 
                                oView2.setBusy(true);                                                                                                                                                                                                          
                            },                                                                                                                                                                                                                                 
                            dataReceived: _dataReceivedAfterBind.bind(this)                                                                                                                                                                                    
                        }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                      
                    }                                                                                                                                                                                                                                          
                );                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
                //set errors table binding                                                                                                                                                                                                                     
                this.setErrorsTable(                                                                                                                                                                                                                           
                    this.thePath,                                                                                                                                                                                                                              
                    this.getI18nText("ErrorsAll")                                                                                                                                                                                                              
                );&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                             
                                                                                                                                                                                                                                                               
                //set obs table binding                                                                                                                                                                                                                        
                //this.setObsTable(this.thePath,"Remarks (All)");&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                        
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                               
                function _dataReceivedAfterBind(oEvent) {                                                                                                                                                                                                      
                    oView2.setBusy(false);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                           
                }                                                                                                                                                                                                                                              
            }, //bindIt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
            refreshIt: function() {                                                                                                                                                                                                                            
                var oModel = this.getView().getModel();                                                                                                                                                                                                        
                oModel.refresh();                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                if (this.oListView)  this.oListView.listRefresh();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&n+
bsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                   
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onValidate: function() {                                                                                                                                                                                                                           
                var oView = this.getView();                                                                                                                                                                                                                    
                var mainModel = oView.getModel();                                                                                                                                                                                                              
                var sPath = oView.getBindingContext().getPath();                                                                                                                                                                                               
                var xml_hd = mainModel.getProperty(sPath);                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                var oUrlParams = {                                                                                                                                                                                                                             
                    "Chave": xml_hd.Chave                                                                                                                                                                                                                      
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                oView.setBusy(true);                                                                                                                                                                                                                           
                mainModel.callFunction(                                                                                                                                                                                                                        
                    "/ValidateAction",                                                                                                                                                                                                                         
                    {                                                                                                                                                                                                                                          
                        method:"POST",&nbsp;                                                                                                                                                                                                                   
                        urlParameters: oUrlParams,&nbsp;                                                                                                                                                                                                       
                        success: _fnSuccess.bind(this),&nbsp;                                                                                                                                                                                                  
                        error: _fnError.bind(this)                                                                                                                                                                                                             
                    }                                                                                                                                                                                                                                          
                );                                                                                                                                                                                                                                             
                function _fnSuccess() {                                                                                                                                                                                                                        
                    this.refreshIt();                                                                                                                                                                                                                          
                    MessageToast.show(                                                                                                                                                                                                                         
                        this.getI18nText("ValidationDone")                                                                                                                                                                                                     
                    );                                                                                                                                                                                                                                         
                }                                                                                                                                                                                                                                              
                function _fnError() {                                                                                                                                                                                                                          
                    debugger;                                                                                                                                                                                                                                  
                    oView.setBusy(false);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nb+
sp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                            
                }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                              
            }, //onValidate                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
            _checkSelItems: function() { //obsolete                                                                                                                                                                                                            
                var aSelItems = this.getView().byId("itemsTable").getSelectedItems();                                                                                                                                                                          
                return (aSelItems.length>0);                                                                                                                                                                                                                   
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            _getSelItemData: function() { //obsolete                                                                                                                                                                                                           
                var aSelItems = this.getView().byId("itemsTable").getSelectedItems();                                                                                                                                                                          
                var sPath = aSelItems[0].getBindingContextPath();                                                                                                                                                                                              
                var oSelItemData = this.getView().getModel().getProperty(sPath);                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                return oSelItemData;                                                                                                                                                                                                                           
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onReleaseOld: function() {                                                                                                                                                                                                                         
                //check for a selected item                                                                                                                                                                                                                    
                if (!this._checkSelItems()) return;                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                //check if it´s already released                                                                                                                                                                                                               
                var oSelItemData = this._getSelItemData();                                                                                                                                                                                                     
                if (oSelItemData.Status=='1') {                                                                                                                                                                                                                
                    MessageBox.error(this.getI18nText("ReleasedItem"));                                                                                                                                                                                        
                    return;                                                                                                                                                                                                                                    
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                //go release it                                                                                                                                                                                                                                
                this.action = "L"; //re[L]ease                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                Message.popUp(this);                                                                                                                                                                                                                           
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onRelease: function() {                                                                                                                                                                                                                            
                var oView = this.getView();                                                                                                                                                                                                                    
                var mainModel = oView.getModel();                                                                                                                                                                                                              
                var sPath = oView.getBindingContext().getPath();                                                                                                                                                                                               
                var xml_hd = mainModel.getProperty(sPath);                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                //check if it´s already released                                                                                                                                                                                                               
                if (xml_hd.Status=='1') {                                                                                                                                                                                                                      
                    MessageBox.error(this.getI18nText("ReleasedNFe"));                                                                                                                                                                                         
                    return;                                                                                                                                                                                                                                    
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                //go release it                                                                                                                                                                                                                                
                this.action = "L"; //re[L]ease                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                Message.popUp(this);                                                                                                                                                                                                                           
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onReject: function() {                                                                                                                                                                                                                             
                var oView = this.getView();                                                                                                                                                                                                                    
                var mainModel = oView.getModel();                                                                                                                                                                                                              
                var sPath = oView.getBindingContext().getPath();                                                                                                                                                                                               
                var xml_hd = mainModel.getProperty(sPath);                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                //check if it´s already rejected                                                                                                                                                                                                               
                if (xml_hd.Status=='9') {                                                                                                                                                                                                                      
                    MessageBox.error(this.getI18nText("RejectNFe"));                                                                                                                                                                                           
                    return;                                                                                                                                                                                                                                    
                }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                              
                                                                                                                                                                                                                                                               
                //go reject it                                                                                                                                                                                                                                 
                this.action = "J"; //re[J]ect                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                Message.popUp(this);                                                                                                                                                                                                                           
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onUndo: function() {                                                                                                                                                                                                                               
                var oView = this.getView();                                                                                                                                                                                                                    
                var mainModel = oView.getModel();                                                                                                                                                                                                              
                var sPath = oView.getBindingContext().getPath();                                                                                                                                                                                               
                var xml_hd = mainModel.getProperty(sPath);                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                //check if it´s already undone                                                                                                                                                                                                                 
                if (xml_hd.Status=='3') {                                                                                                                                                                                                                      
                    MessageBox.error(this.getI18nText("UndoneNFe"));                                                                                                                                                                                           
                    return;                                                                                                                                                                                                                                    
                }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                              
                                                                                                                                                                                                                                                               
                //go undo it                                                                                                                                                                                                                                   
                this.action = "U"; //[U]ndo                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                Message.popUp(this);                                                                                                                                                                                                                           
            },&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                         
                                                                                                                                                                                                                                                               
            onCancMessagePopup: function() {                                                                                                                                                                                                                   
                Message.close(this);                                                                                                                                                                                                                           
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onOkMessagePopupOld: function() { //obsolete                                                                                                                                                                                                       
                var oView = this.getView();                                                                                                                                                                                                                    
                var globalModel = this.getGlobalModel();                                                                                                                                                                                                       
                var globalModelData = globalModel.getData();                                                                                                                                                                                                   
                var message = globalModelData.Message;                                                                                                                                                                                                         
                var mainModel = oView.getModel();                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                var aSelItems = oView.byId("itemsTable").getSelectedItems();                                                                                                                                                                                   
                aSelItems.forEach(                                                                                                                                                                                                                             
                    (item)=>{                                                                                                                                                                                                                                  
                        //call the backend action                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                        var sPath = item.getBindingContextPath();                                                                                                                                                                                              
                        var xml_it = mainModel.getProperty(sPath);                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
                        var oUrlParams = {                                                                                                                                                                                                                     
                            "Chave": xml_it.Chave,                                                                                                                                                                                                             
                            "Id": xml_it.Id,                                                                                                                                                                                                                   
                            "Action": this.action,&nbsp;                                                                                                                                                                                                       
                            "Message": message                                                                                                                                                                                                                 
                        }                                                                                                                                                                                                                                      
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                               
                        oView.setBusy(true);                                                                                                                                                                                                                   
                        mainModel.callFunction(                                                                                                                                                                                                                
                            "/StatusChangeAction",                                                                                                                                                                                                             
                            {                                                                                                                                                                                                                                  
                                method:"POST",&nbsp;                                                                                                                                                                                                           
                                urlParameters: oUrlParams,&nbsp;                                                                                                                                                                                               
                                success: _fnSuccess.bind(this),&nbsp;                                                                                                                                                                                          
                                error: _fnError.bind(this)                                                                                                                                                                                                     
                            }                                                                                                                                                                                                                                  
                        );                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        function _fnSuccess(ctx) {                                                                                                                                                                                                             
                            oView.setBusy(false);                                                                                                                                                                                                              
                            Message.close(this);                                                                                                                                                                                                               
                            this.refreshIt();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                          
                        }                                                                                                                                                                                                                                      
                        function _fnError(ctx) {                                                                                                                                                                                                               
                            oView.setBusy(false);                                                                                                                                                                                                              
                            Message.close(this);                                                                                                                                                                                                               
                            debugger;                                                                                                                                                                                                                          
                        }                                                                                                                                                                                                                                      
                    }                                                                                                                                                                                                                                          
                ); //forEach selected row                                                                                                                                                                                                                      
            }, //onOkMessagePopup                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
            onOkMessagePopup: function() {                                                                                                                                                                                                                     
                var oView = this.getView();                                                                                                                                                                                                                    
                var globalModel = this.getGlobalModel();                                                                                                                                                                                                       
                var globalModelData = globalModel.getData();                                                                                                                                                                                                   
                var message = globalModelData.Message;                                                                                                                                                                                                         
                var mainModel = oView.getModel();                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                var sPath = oView.getBindingContext().getPath();                                                                                                                                                                                               
                var xml_hd = mainModel.getProperty(sPath);                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                var oUrlParams = {                                                                                                                                                                                                                             
                    "Chave": xml_hd.Chave,                                                                                                                                                                                                                     
                    "Action": this.action,&nbsp;                                                                                                                                                                                                               
                    "Message": message                                                                                                                                                                                                                         
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                oView.setBusy(true);                                                                                                                                                                                                                           
                mainModel.callFunction(                                                                                                                                                                                                                        
                    "/StatusChangeAction",                                                                                                                                                                                                                     
                    {                                                                                                                                                                                                                                          
                        method:"POST",&nbsp;                                                                                                                                                                                                                   
                        urlParameters: oUrlParams,&nbsp;                                                                                                                                                                                                       
                        success: _fnSuccess.bind(this),&nbsp;                                                                                                                                                                                                  
                        error: _fnError.bind(this)                                                                                                                                                                                                             
                    }                                                                                                                                                                                                                                          
                );                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
                function _fnSuccess(ctx) {                                                                                                                                                                                                                     
                    oView.setBusy(false);                                                                                                                                                                                                                      
                    Message.close(this);                                                                                                                                                                                                                       
                    this.refreshIt();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                  
                }                                                                                                                                                                                                                                              
                function _fnError(ctx) {                                                                                                                                                                                                                       
                    oView.setBusy(false);                                                                                                                                                                                                                      
                    Message.close(this);                                                                                                                                                                                                                       
                    debugger;                                                                                                                                                                                                                                  
                }                                                                                                                                                                                                                                              
            }, //onOkMessagePopup                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
            onArchiveUnarchive: function() {                                                                                                                                                                                                                   
                var xml_hd = this.getView().getModel().getProperty(this.getView().getBindingContext().getPath());                                                                                                                                              
                                                                                                                                                                                                                                                               
                switch (xml_hd.Archive) {                                                                                                                                                                                                                      
                    case "X":                                                                                                                                                                                                                                  
                        this.unarchive(xml_hd);                                                                                                                                                                                                                
                        break;                                                                                                                                                                                                                                 
                    case "":                                                                                                                                                                                                                                   
                        this.archive(xml_hd);                                                                                                                                                                                                                  
                        break;                                                                                                                                                                                                                                 
                }                                                                                                                                                                                                                                              
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            archive: function(xml_hd) {                                                                                                                                                                                                                        
                //Verificar se nas chaves de NF-e, o status de controle está LIBERADO ou RECUSADO&nbsp;                                                                                                                                                        
                //ou status de validação está com OK (Semáforo Verde)&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                //var xml_hd = this.getView().getModel().getProperty(this.getView().getBindingContext().getPath());                                                                                                                                            
                if&nbsp;                                                                                                                                                                                                                                       
                    (!                                                                                                                                                                                                                                         
                        (xml_hd.Status=="1"||xml_hd.Status=="9")&nbsp;                                                                                                                                                                                         
                        ||                                                                                                                                                                                                                                     
                        (xml_hd.StatusValid=="S")                                                                                                                                                                                                              
                    )&nbsp;                                                                                                                                                                                                                                    
                {                                                                                                                                                                                                                                              
                    MessageBox.error(this.getI18nText("IncorrectStatus"));                                                                                                                                                                                     
                    return;                                                                                                                                                                                                                                    
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                //call the backend action                                                                                                                                                                                                                      
                this.fileActionCall("F");                                                                                                                                                                                                                      
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            unarchive: function(xml_hd) {                                                                                                                                                                                                                      
                //call the backend action                                                                                                                                                                                                                      
                this.fileActionCall("U","dummy");                                                                                                                                                                                                              
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onDivergences: function() {                                                                                                                                                                                                                        
                Divergences.popUp(this);                                                                                                                                                                                                                       
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onCancDivergencesPopup: function() {                                                                                                                                                                                                               
                Divergences.close(this);                                                                                                                                                                                                                       
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onOkDivergencesPopup: function() {                                                                                                                                                                                                                 
                var oView = this.getView();                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                var aSelItems = sap.ui.getCore().byId("cadDivList").getSelectedContexts();                                                                                                                                                                     
                var sCods = "";                                                                                                                                                                                                                                
                aSelItems.forEach((item)=>                                                                                                                                                                                                                     
                {                                                                                                                                                                                                                                              
                    if (sCods) {                                                                                                                                                                                                                               
                        sCods+=";";                                                                                                                                                                                                                            
                    }                                                                                                                                                                                                                                          
                    sCods+=item.getProperty("CodDiv");                                                                                                                                                                                                         
                }); //forEach selected row&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                         
                                                                                                                                                                                                                                                               
                //call the backend action                                                                                                                                                                                                                      
                this.divActionCall(sCods);                                                                                                                                                                                                                     
            }, //onOkDivergencesPopup                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
            onDivShow: function() {                                                                                                                                                                                                                            
                DivergencesShow.popUp(this);                                                                                                                                                                                                                   
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onOkDivergencesShowPopup: function() {                                                                                                                                                                                                             
                DivergencesShow.close(this);                                                                                                                                                                                                                   
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            fileActionCall(action) {                                                                                                                                                                                                                           
                var oView = this.getView();                                                                                                                                                                                                                    
                var mainModel = oView.getModel();                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                var sPath = oView.getBindingContext().getPath();                                                                                                                                                                                               
                var xml_hd = mainModel.getProperty(sPath);                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                var oUrlParams = {                                                                                                                                                                                                                             
                    "Chave": xml_hd.Chave,                                                                                                                                                                                                                     
                    "Action": action                                                                                                                                                                                                                           
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                oView.setBusy(true);                                                                                                                                                                                                                           
                mainModel.callFunction(                                                                                                                                                                                                                        
                    "/FileAction",                                                                                                                                                                                                                             
                    {                                                                                                                                                                                                                                          
                        method:"POST",&nbsp;                                                                                                                                                                                                                   
                        urlParameters: oUrlParams,&nbsp;                                                                                                                                                                                                       
                        success: _fnSuccess.bind(this),&nbsp;                                                                                                                                                                                                  
                        error: _fnError.bind(this)                                                                                                                                                                                                             
                    }                                                                                                                                                                                                                                          
                );                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
                function _fnSuccess(ctx) {                                                                                                                                                                                                                     
                    oView.setBusy(false);                                                                                                                                                                                                                      
                    Divergences.close(this);                                                                                                                                                                                                                   
                    this.refreshIt();                                                                                                                                                                                                                          
                }                                                                                                                                                                                                                                              
                function _fnError(ctx) {                                                                                                                                                                                                                       
                    oView.setBusy(false);                                                                                                                                                                                                                      
                    Divergences.close(this);                                                                                                                                                                                                                   
                    debugger;                                                                                                                                                                                                                                  
                }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                            
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
            divActionCall(sCods) {                                                                                                                                                                                                                             
                var oView = this.getView();                                                                                                                                                                                                                    
                var mainModel = oView.getModel();                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                var sPath = oView.getBindingContext().getPath();                                                                                                                                                                                               
                var xml_hd = mainModel.getProperty(sPath);                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                var oUrlParams = {                                                                                                                                                                                                                             
                    "Chave": xml_hd.Chave,                                                                                                                                                                                                                     
                    "Message": sCods                                                                                                                                                                                                                           
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                oView.setBusy(true);                                                                                                                                                                                                                           
                mainModel.callFunction(                                                                                                                                                                                                                        
                    "/DivAction",                                                                                                                                                                                                                              
                    {                                                                                                                                                                                                                                          
                        method:"POST",&nbsp;                                                                                                                                                                                                                   
                        urlParameters: oUrlParams,&nbsp;                                                                                                                                                                                                       
                        success: _fnSuccess.bind(this),&nbsp;                                                                                                                                                                                                  
                        error: _fnError.bind(this)                                                                                                                                                                                                             
                    }                                                                                                                                                                                                                                          
                );                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
                function _fnSuccess(ctx) {                                                                                                                                                                                                                     
                    oView.setBusy(false);                                                                                                                                                                                                                      
                    Divergences.close(this);                                                                                                                                                                                                                   
                    this.refreshIt();                                                                                                                                                                                                                          
                }                                                                                                                                                                                                                                              
                function _fnError(ctx) {                                                                                                                                                                                                                       
                    oView.setBusy(false);                                                                                                                                                                                                                      
                    Divergences.close(this);                                                                                                                                                                                                                   
                    debugger;                                                                                                                                                                                                                                  
                }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                            
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onXml: function() {                                                                                                                                                                                                                                
                var sPath = this.getView().getBindingContext().getPath();                                                                                                                                                                                      
                var objData = this.getView().getModel().getProperty(sPath);                                                                                                                                                                                    
                //ContentViewer.popUp(this,objData.XmlStr);                                                                                                                                                                                                    
                var XmlStr = objData.XmlStr;                                                                                                                                                                                                                   
                XmlStr = XmlStr.replace(/&amp;/g, " ").replace(/&lt;/g, "|").replace(/&gt;/g, "|");                                                                                                                                                            
                ContentViewer.popUp(this,XmlStr);                                                                                                                                                                                                              
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onRefXml: function() {                                                                                                                                                                                                                             
                var sPath = this.getView().getBindingContext().getPath();                                                                                                                                                                                      
                var objData = this.getView().getModel().getProperty(sPath);                                                                                                                                                                                    
                ContentViewer.popUp(this,objData.RefXmlStr);                                                                                                                                                                                                   
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onOkContentViewer: function() {                                                                                                                                                                                                                    
                ContentViewer.close(this);                                                                                                                                                                                                                     
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onItemPressed: function(oEvent) {                                                                                                                                                                                                                  
                //selected item                                                                                                                                                                                                                                
&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                                       
				var oItem, oCtx, sPath;                                                                                                                                                                                                                                    
				oItem = oEvent.getSource();                                                                                                                                                                                                                                
				oCtx = oItem.getBindingContext();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                          
				sPath = oEvent.getSource().getBindingContext().getPath();&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                          
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                               
                this.selItem = oCtx; //obsolete                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
                //enable item´s details                                                                                                                                                                                                                        
                this.getView().byId("itemDetails").setVisible(true);                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
                //ItemDetails section title                                                                                                                                                                                                                    
                var local = this.getView().getModel("local");                                                                                                                                                                                                  
                var localData = local.getData();                                                                                                                                                                                                               
                localData.itemDetailsTitle = "(Item: " + this.selItem.getProperty("Id") + ")";                                                                                                                                                                 
                localData.selItem = this.selItem;                                                                                                                                                                                                              
                local.setData(localData);                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                var oItemDetailsSection = this.getView().byId("itemDetails");                                                                                                                                                                                  
                oItemDetailsSection.bindElement(sPath);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                        
                                                                                                                                                                                                                                                               
                //errors table                                                                                                                                                                                                                                 
                var title =&nbsp;                                                                                                                                                                                                                              
                    this.getI18nText("Errors")                                                                                                                                                                                                                 
                    + " (Item: " + this.selItem.getProperty("Id") + ")";                                                                                                                                                                                       
                this.setErrorsTable(sPath,title);                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                //remarks table                                                                                                                                                                                                                                
                title =&nbsp;                                                                                                                                                                                                                                  
                    this.getI18nText("Remarks")                                                                                                                                                                                                                
                    + " (Item: " + this.selItem.getProperty("Id") + ")";                                                                                                                                                                                       
                //this.setObsTable(sPath,title);                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
            }, //onItemPressed                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            setErrorsTable: function(sPath,title) {                                                                                                                                                                                                            
                //the errors table depends on the selected item.                                                                                                                                                                                               
                //or may be all errors when chosen or initial                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                var that = this;                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                setErrorsBinding(sPath);                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                setErrorsTitle(title);                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                function setErrorsBinding(sPath) {                                                                                                                                                                                                             
                    var oTable;                                                                                                                                                                                                                                
                    //active                                                                                                                                                                                                                                   
                    oTable = that.getView().byId("errorsTable");                                                                                                                                                                                               
                    oTable.bindElement({path:sPath});                                                                                                                                                                                                          
                    //oTable.getBinding("items").refresh();                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                    //inactive                                                                                                                                                                                                                                 
                    oTable = that.getView().byId("errorsTableInactive");                                                                                                                                                                                       
                    oTable.bindElement({path:sPath});                                                                                                                                                                                                          
                    //oTable.getBinding("items").refresh();                                                                                                                                                                                                    
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                function setErrorsTitle(sTitle) {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                              
                    //errors section title                                                                                                                                                                                                                     
                    var local = that.getView().getModel("local");                                                                                                                                                                                              
                    var localData = local.getData();                                                                                                                                                                                                           
                    localData.errorsTitle = sTitle;                                                                                                                                                                                                            
                    local.setData(localData);                                                                                                                                                                                                                  
                }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                              
            }, //setErrorsTable                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
            setObsTable: function(sPath,title) {                                                                                                                                                                                                               
                //the obs table depends on the selected item.                                                                                                                                                                                                  
                //or may be all obs when chosen or initial                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                var that = this;                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                setObsBinding(sPath);                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                setObsTitle(title);                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                function setObsBinding(sPath) {                                                                                                                                                                                                                
                    var oTable;                                                                                                                                                                                                                                
                    oTable = that.getView().byId("obsTable");                                                                                                                                                                                                  
                    oTable.bindElement({path:sPath});                                                                                                                                                                                                          
                    oTable.getBinding("items").refresh();                                                                                                                                                                                                      
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                function setObsTitle(sTitle) {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                 
                    //obs section title                                                                                                                                                                                                                        
                    var local = that.getView().getModel("local");                                                                                                                                                                                              
                    var localData = local.getData();                                                                                                                                                                                                           
                    localData.obsTitle = sTitle;                                                                                                                                                                                                               
                    local.setData(localData);                                                                                                                                                                                                                  
                }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                              
            }, //setObsTable                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
            onXPEDChange: function(oEvent) {                                                                                                                                                                                                                   
                let local = this.getView().getModel("local");                                                                                                                                                                                                  
                let localData = local.getData();                                                                                                                                                                                                               
                localData.pendingItemChange = true;                                                                                                                                                                                                            
                local.setData(localData);                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                return;                                                                                                                                                                                                                                        
/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                             
Lógica antiga que enviava o valor na hora via action. Substituido pelo botão do onItemsPedSave                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                var newValue = oEvent.getParameters().newValue;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                
                                                                                                                                                                                                                                                               
                //pass it to the backend via action                                                                                                                                                                                                            
                var oView = this.getView();                                                                                                                                                                                                                    
                var mainModel = oView.getModel();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                               
                var sPath = oEvent.getSource().getBindingContext().getPath();                                                                                                                                                                                  
                var xml_it = mainModel.getProperty(sPath);                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                var oUrlParams = {                                                                                                                                                                                                                             
                    "Chave": xml_it.Chave,                                                                                                                                                                                                                     
                    "Id": xml_it.Id,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                   
                    "XPed": newValue                                                                                                                                                                                                                           
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                oView.setBusy(true);                                                                                                                                                                                                                           
                mainModel.callFunction(                                                                                                                                                                                                                        
                    "/XPedChangeAction",                                                                                                                                                                                                                       
                    {                                                                                                                                                                                                                                          
                        method:"POST",&nbsp;                                                                                                                                                                                                                   
                        urlParameters: oUrlParams,&nbsp;                                                                                                                                                                                                       
                        success: _fnSuccess.bind(this),&nbsp;                                                                                                                                                                                                  
                        error: _fnError.bind(this)                                                                                                                                                                                                             
                    }                                                                                                                                                                                                                                          
                );                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
                function _fnSuccess(ctx) {                                                                                                                                                                                                                     
                    oView.setBusy(false);                                                                                                                                                                                                                      
                    MessageToast.show(this.getI18nText("POChanged"));                                                                                                                                                                                          
                    this.refreshIt();                                                                                                                                                                                                                          
                }                                                                                                                                                                                                                                              
                function _fnError(ctx) {                                                                                                                                                                                                                       
                    oView.setBusy(false);                                                                                                                                                                                                                      
                    debugger;                                                                                                                                                                                                                                  
                }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                              
*/                                                                                                                                                                                                                                                             
            }, //onXPEDChange                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            onNItemPedChange: function(oEvent) {                                                                                                                                                                                                               
                let local = this.getView().getModel("local");                                                                                                                                                                                                  
                let localData = local.getData();                                                                                                                                                                                                               
                localData.pendingItemChange = true;                                                                                                                                                                                                            
                local.setData(localData);                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                return;                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
/*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                             
Lógica antiga que enviava o valor na hora via action. Substituido pelo botão do onItemsPedSave                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                var newValue = oEvent.getParameters().newValue;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                
                                                                                                                                                                                                                                                               
                //pass it to the backend via action                                                                                                                                                                                                            
                var oView = this.getView();                                                                                                                                                                                                                    
                var mainModel = oView.getModel();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                               
                var sPath = oEvent.getSource().getBindingContext().getPath();                                                                                                                                                                                  
                var xml_it = mainModel.getProperty(sPath);                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                var oUrlParams = {                                                                                                                                                                                                                             
                    "Chave": xml_it.Chave,                                                                                                                                                                                                                     
                    "Id": xml_it.Id,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                   
                    "NItemPed": newValue                                                                                                                                                                                                                       
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                oView.setBusy(true);                                                                                                                                                                                                                           
                mainModel.callFunction(                                                                                                                                                                                                                        
                    "/NItemPedChangeAction",                                                                                                                                                                                                                   
                    {                                                                                                                                                                                                                                          
                        method:"POST",&nbsp;                                                                                                                                                                                                                   
                        urlParameters: oUrlParams,&nbsp;                                                                                                                                                                                                       
                        success: _fnSuccess.bind(this),&nbsp;                                                                                                                                                                                                  
                        error: _fnError.bind(this)                                                                                                                                                                                                             
                    }                                                                                                                                                                                                                                          
                );                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
                function _fnSuccess(ctx) {                                                                                                                                                                                                                     
                    oView.setBusy(false);                                                                                                                                                                                                                      
                    MessageToast.show();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                             
                    MessageToast.show(this.getI18nText("POItemChanged"));&nbsp;&nbsp;                                                                                                                                                                          
                    this.refreshIt();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                        
                }                                                                                                                                                                                                                                              
                function _fnError(ctx) {                                                                                                                                                                                                                       
                    oView.setBusy(false);                                                                                                                                                                                                                      
                    debugger;                                                                                                                                                                                                                                  
                }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                              
*/                                                                                                                                                                                                                                                             
            }, //onNItemPedChange                                                                                                                                                                                                                              
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                       
            onItemsPedSave: function(oEvent) {                                                                                                                                                                                                                 
                function _getCellValue(aCells,sPath) {                                                                                                                                                                                                         
                    for(let i=0;i<=aCells.length;i++) {                                                                                                                                                                                                        
                        if (    aCells[i].mBindingInfos.value                                                                                                                                                                                                  
                            &&  (aCells[i].mBindingInfos.value.binding.sPath==sPath)) {                                                                                                                                                                        
                            let nCellValue = aCells[i].mProperties.value.trim();                                                                                                                                                                               
                            return nCellValue;                                                                                                                                                                                                                 
                        }                                                                                                                                                                                                                                      
                    }                                                                                                                                                                                                                                          
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                //pass the pending changes to the oData model (backend)                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                let oView = this.getView();                                                                                                                                                                                                                    
                let oMainModel = oView.getModel();&nbsp;&nbsp;&nbsp;                                                                                                                                                                                           
                let oItemsTable = oView.byId("itemsTable");                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                //loop the table´s items                                                                                                                                                                                                                       
                oItemsTable.getItems().forEach((item)=>{                                                                                                                                                                                                       
                    let oModelItem = oMainModel.getProperty(item.getBindingContext().getPath());                                                                                                                                                               
                                                                                                                                                                                                                                                               
                    let aCells = item.mAggregations.cells;                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                    //set XPed if different                                                                                                                                                                                                                    
                    let nXPedFrontValue =&nbsp;                                                                                                                                                                                                                
                        _getCellValue(aCells,"XPed");                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                    if (nXPedFrontValue!==oModelItem.XPed.toString()) {                                                                                                                                                                                        
                        oMainModel.setProperty(                                                                                                                                                                                                                
                            item.getBindingContext().getPath()+"/XPed",                                                                                                                                                                                        
                            nXPedFrontValue.toString()                                                                                                                                                                                                         
                        );                                                                                                                                                                                                                                     
                    }                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                    //set NItemPed if different                                                                                                                                                                                                                
                    let nItemPedFrontValue =&nbsp;                                                                                                                                                                                                             
                        _getCellValue(aCells,"NItemPed");                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                    if (nItemPedFrontValue!==oModelItem.NItemPed.toString()) {                                                                                                                                                                                 
                        oMainModel.setProperty(                                                                                                                                                                                                                
                            item.getBindingContext().getPath()+"/NItemPed",                                                                                                                                                                                    
                            parseInt(nItemPedFrontValue)                                                                                                                                                                                                       
                        );                                                                                                                                                                                                                                     
                    }                                                                                                                                                                                                                                          
                }); //items                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                //send to backend if there where any changes                                                                                                                                                                                                   
                if (oMainModel.hasPendingChanges()) {                                                                                                                                                                                                          
                    oMainModel.submitChanges(                                                                                                                                                                                                                  
                        {                                                                                                                                                                                                                                      
                            success: _fnSuccess.bind(this),&nbsp;                                                                                                                                                                                              
                            error: _fnError.bind(this)                                                                                                                                                                                                         
                        }                                                                                                                                                                                                                                      
                    );                                                                                                                                                                                                                                         
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                //disable the Save button                                                                                                                                                                                                                      
                let local = this.getView().getModel("local");                                                                                                                                                                                                  
                let localData = local.getData();                                                                                                                                                                                                               
                localData.pendingItemChange = false;                                                                                                                                                                                                           
                local.setData(localData);                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                //callbacks                                                                                                                                                                                                                                    
                function _fnSuccess(ctx) {                                                                                                                                                                                                                     
                    oView.setBusy(false);                                                                                                                                                                                                                      
                    this.refreshIt();                                                                                                                                                                                                                          
                }                                                                                                                                                                                                                                              
                function _fnError(ctx) {                                                                                                                                                                                                                       
                    oView.setBusy(false);                                                                                                                                                                                                                      
                    debugger;                                                                                                                                                                                                                                  
                }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                            
            },                                                                                                                                                                                                                                                 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                       
            onPinChange: function(oEvent) {                                                                                                                                                                                                                    
                var newValue = oEvent.getParameters().newValue;                                                                                                                                                                                                
                if (!newValue) {                                                                                                                                                                                                                               
                    newValue = this.getView().byId("pin").getSelectedKey();                                                                                                                                                                                    
                }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                              
                                                                                                                                                                                                                                                               
                //pass it to the backend via action                                                                                                                                                                                                            
                var oView = this.getView();                                                                                                                                                                                                                    
                var mainModel = oView.getModel();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                               
                var sPath = oEvent.getSource().getBindingContext().getPath();                                                                                                                                                                                  
                var xml_hd = mainModel.getProperty(sPath);                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                var oUrlParams = {                                                                                                                                                                                                                             
                    "Chave": xml_hd.Chave,                                                                                                                                                                                                                     
                    "Pin": newValue                                                                                                                                                                                                                            
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                oView.setBusy(true);                                                                                                                                                                                                                           
                mainModel.callFunction(                                                                                                                                                                                                                        
                    "/PinChangeAction",                                                                                                                                                                                                                        
                    {                                                                                                                                                                                                                                          
                        method:"POST",&nbsp;                                                                                                                                                                                                                   
                        urlParameters: oUrlParams,&nbsp;                                                                                                                                                                                                       
                        success: _fnSuccess.bind(this),&nbsp;                                                                                                                                                                                                  
                        error: _fnError.bind(this)                                                                                                                                                                                                             
                    }                                                                                                                                                                                                                                          
                );                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
                function _fnSuccess(ctx) {                                                                                                                                                                                                                     
                    oView.setBusy(false);                                                                                                                                                                                                                      
                    MessageToast.show("Pin has been changed.");&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                          
                }                                                                                                                                                                                                                                              
                function _fnError(ctx) {                                                                                                                                                                                                                       
                    oView.setBusy(false);                                                                                                                                                                                                                      
                    debugger;                                                                                                                                                                                                                                  
                }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                              
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onActReqChange: function(oEvent) {                                                                                                                                                                                                                 
                var newValue = oEvent.getParameters().newValue;                                                                                                                                                                                                
                if (!newValue) {                                                                                                                                                                                                                               
                    newValue = this.getView().byId("actionRequired").getSelectedKey();                                                                                                                                                                         
                }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                              
                                                                                                                                                                                                                                                               
                //pass it to the backend via action                                                                                                                                                                                                            
                var oView = this.getView();                                                                                                                                                                                                                    
                var mainModel = oView.getModel();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                               
                var sPath = oEvent.getSource().getBindingContext().getPath();                                                                                                                                                                                  
                var xml_hd = mainModel.getProperty(sPath);                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                var oUrlParams = {                                                                                                                                                                                                                             
                    "Chave": xml_hd.Chave,                                                                                                                                                                                                                     
                    "ActReq": newValue                                                                                                                                                                                                                         
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                oView.setBusy(true);                                                                                                                                                                                                                           
                mainModel.callFunction(                                                                                                                                                                                                                        
                    "/ActReqChangeAction",                                                                                                                                                                                                                     
                    {                                                                                                                                                                                                                                          
                        method:"POST",&nbsp;                                                                                                                                                                                                                   
                        urlParameters: oUrlParams,&nbsp;                                                                                                                                                                                                       
                        success: _fnSuccess.bind(this),&nbsp;                                                                                                                                                                                                  
                        error: _fnError.bind(this)                                                                                                                                                                                                             
                    }                                                                                                                                                                                                                                          
                );                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
                function _fnSuccess(ctx) {                                                                                                                                                                                                                     
                    oView.setBusy(false);                                                                                                                                                                                                                      
                    this.refreshIt();                                                                                                                                                                                                                          
                    MessageToast.show(this.getI18nText("ActReqChanged"));&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                
                }                                                                                                                                                                                                                                              
                function _fnError(ctx) {                                                                                                                                                                                                                       
                    oView.setBusy(false);                                                                                                                                                                                                                      
                    debugger;                                                                                                                                                                                                                                  
                }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                              
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onAllItems: function() {                                                                                                                                                                                                                           
                var local = this.getView().getModel("local");                                                                                                                                                                                                  
                var localData = local.getData();                                                                                                                                                                                                               
                this.selItem = null;                                                                                                                                                                                                                           
                localData.selItem = null;                                                                                                                                                                                                                      
                local.setData(localData);                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                this.setErrorsTable(                                                                                                                                                                                                                           
                    this.thePath,                                                                                                                                                                                                                              
                    this.getI18nText("ErrorsAll")                                                                                                                                                                                                              
                );&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                           
                //this.setObsTable(this.thePath,"Remarks (All)");&nbsp;&nbsp;&nbsp;                                                                                                                                                                            
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onSendObs: function() { //level item: obsolete                                                                                                                                                                                                     
                if (!this.selItem) return;                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                var oView = this.getView();                                                                                                                                                                                                                    
                var mainModel = oView.getModel();                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                var sPath = this.selItem.getPath();                                                                                                                                                                                                            
                var xml_it = mainModel.getProperty(sPath);                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                var local = this.getView().getModel("local");                                                                                                                                                                                                  
                var localModelData = local.getData();                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                var sObs = localModelData.Obs;                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                //clean it after use it                                                                                                                                                                                                                        
                localModelData.Obs = "";&nbsp;                                                                                                                                                                                                                 
                local.setData(localModelData);                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                //set the parameters                                                                                                                                                                                                                           
                var oUrlParams = {                                                                                                                                                                                                                             
                    "Chave": xml_it.Chave,                                                                                                                                                                                                                     
                    "Id": xml_it.Id,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                     
                    "Obs": sObs                                                                                                                                                                                                                                
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                //send to backend                                                                                                                                                                                                                              
                oView.setBusy(true);                                                                                                                                                                                                                           
                mainModel.callFunction(                                                                                                                                                                                                                        
                    "/ObsSendAction",                                                                                                                                                                                                                          
                    {                                                                                                                                                                                                                                          
                        method:"POST",&nbsp;                                                                                                                                                                                                                   
                        urlParameters: oUrlParams,&nbsp;                                                                                                                                                                                                       
                        success: _fnSuccess.bind(this),&nbsp;                                                                                                                                                                                                  
                        error: _fnError.bind(this)                                                                                                                                                                                                             
                    }                                                                                                                                                                                                                                          
                );                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
                function _fnSuccess(ctx) {                                                                                                                                                                                                                     
                    oView.setBusy(false);                                                                                                                                                                                                                      
                    this.refreshIt();                                                                                                                                                                                                                          
                }                                                                                                                                                                                                                                              
                function _fnError(ctx) {                                                                                                                                                                                                                       
                    oView.setBusy(false);                                                                                                                                                                                                                      
                    debugger;                                                                                                                                                                                                                                  
                }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                            
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onSendObsH: function() {                                                                                                                                                                                                                           
                var oView = this.getView();                                                                                                                                                                                                                    
                var mainModel = oView.getModel();                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                var sPath = oView.getBindingContext().getPath();                                                                                                                                                                                               
                var xml_hd = mainModel.getProperty(sPath);                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                var local = this.getView().getModel("local");                                                                                                                                                                                                  
                var localModelData = local.getData();                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                var sObs = localModelData.Obs;                                                                                                                                                                                                                 
                if (!sObs) return;                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
                //clean it after use it                                                                                                                                                                                                                        
                localModelData.Obs = "";&nbsp;                                                                                                                                                                                                                 
                local.setData(localModelData);                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                //set the parameters                                                                                                                                                                                                                           
                var oUrlParams = {                                                                                                                                                                                                                             
                    "Chave": xml_hd.Chave,                                                                                                                                                                                                                     
                    "Obs": sObs                                                                                                                                                                                                                                
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                //send to backend                                                                                                                                                                                                                              
                oView.setBusy(true);                                                                                                                                                                                                                           
                mainModel.callFunction(                                                                                                                                                                                                                        
                    "/ObsHSendAction",                                                                                                                                                                                                                         
                    {                                                                                                                                                                                                                                          
                        method:"POST",&nbsp;                                                                                                                                                                                                                   
                        urlParameters: oUrlParams,&nbsp;                                                                                                                                                                                                       
                        success: _fnSuccess.bind(this),&nbsp;                                                                                                                                                                                                  
                        error: _fnError.bind(this)                                                                                                                                                                                                             
                    }                                                                                                                                                                                                                                          
                );                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
                function _fnSuccess(ctx) {                                                                                                                                                                                                                     
                    oView.setBusy(false);                                                                                                                                                                                                                      
                    this.refreshIt();                                                                                                                                                                                                                          
                }                                                                                                                                                                                                                                              
                function _fnError(ctx) {                                                                                                                                                                                                                       
                    oView.setBusy(false);                                                                                                                                                                                                                      
                    debugger;                                                                                                                                                                                                                                  
                }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                            
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onNfWrite_old: function() {                                                                                                                                                                                                                        
                var oView = this.getView();                                                                                                                                                                                                                    
                var mainModel = oView.getModel();                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                var sPath = oView.getBindingContext().getPath();                                                                                                                                                                                               
                var xml_hd = mainModel.getProperty(sPath);                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                //set the parameters                                                                                                                                                                                                                           
                var oUrlParams = {                                                                                                                                                                                                                             
                    "Chave": xml_hd.Chave                                                                                                                                                                                                                      
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                //send to backend                                                                                                                                                                                                                              
                oView.setBusy(true);                                                                                                                                                                                                                           
                mainModel.callFunction(                                                                                                                                                                                                                        
                    "/NfWriteAction",                                                                                                                                                                                                                          
                    {                                                                                                                                                                                                                                          
                        method:"POST",&nbsp;                                                                                                                                                                                                                   
                        urlParameters: oUrlParams,&nbsp;                                                                                                                                                                                                       
                        success: _fnSuccess.bind(this),&nbsp;                                                                                                                                                                                                  
                        error: _fnError.bind(this)                                                                                                                                                                                                             
                    }                                                                                                                                                                                                                                          
                );                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
                function _fnSuccess(oResponse) {                                                                                                                                                                                                               
                    oView.setBusy(false);                                                                                                                                                                                                                      
                    this.refreshIt();                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                    //result                                                                                                                                                                                                                                   
                    if (oResponse&&oResponse.results) {                                                                                                                                                                                                        
                        //check if it was successful                                                                                                                                                                                                           
                        let docnum = _getDocnum(oResponse.results);                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                        if (docnum) {                                                                                                                                                                                                                          
                            MessageToast.show(                                                                                                                                                                                                                 
                                    this.getI18nText("document")                                                                                                                                                                                               
                                +   " "                                                                                                                                                                                                                        
                                +   docnum                                                                                                                                                                                                                     
                                +   " "                                                                                                                                                                                                                        
                                +   this.getI18nText("success")                                                                                                                                                                                                
                                +   "!"                                                                                                                                                                                                                        
                            );                                                                                                                                                                                                                                 
                        } else {                                                                                                                                                                                                                               
                            //if not successful call the messages popup                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                            // pass the result messages to the global model                                                                                                                                                                                    
                            let oModel = this.getGlobalModel();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                            
                            var oGlobalModelData = oModel.getData();                                                                                                                                                                                           
                            oGlobalModelData.NfWriteMsgs = oResponse.results;                                                                                                                                                                                  
                            oModel.setData(oGlobalModelData);                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                            //show the result                                                                                                                                                                                                                  
                            NfWriteMsgs.popUp(this);                                                                                                                                                                                                           
                        } //not successful                                                                                                                                                                                                                     
                    }                                                                                                                                                                                                                                          
                } //_fnSuccess                                                                                                                                                                                                                                 
                function _fnError(ctx) {                                                                                                                                                                                                                       
                    oView.setBusy(false);                                                                                                                                                                                                                      
                    debugger;                                                                                                                                                                                                                                  
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                function _getDocnum(aResults) {                                                                                                                                                                                                                
                    for (let i=0;i<aResults.length;i++) {                                                                                                                                                                                                      
                        if (aResults[i].Docnum!="") {                                                                                                                                                                                                          
                            return aResults[i].Docnum;                                                                                                                                                                                                         
                        }                                                                                                                                                                                                                                      
                    }                                                                                                                                                                                                                                          
                }                                                                                                                                                                                                                                              
            }, //onNfWrite                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
            onNfWrite: function() {                                                                                                                                                                                                                            
                var oView = this.getView();                                                                                                                                                                                                                    
                var mainModel = oView.getModel();                                                                                                                                                                                                              
                var efdModel = oView.getModel("efdNfWriter");                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                var sPath = oView.getBindingContext().getPath();                                                                                                                                                                                               
                var xml_hd = mainModel.getProperty(sPath);                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                //set the parameters                                                                                                                                                                                                                           
                var oProps = {                                                                                                                                                                                                                                 
                    "AccessKey": xml_hd.Chave                                                                                                                                                                                                                  
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                //send to backend                                                                                                                                                                                                                              
                oView.setBusy(true);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
                efdModel.createEntry(                                                                                                                                                                                                                          
                    "NFESet",                                                                                                                                                                                                                                  
                    {&nbsp;                                                                                                                                                                                                                                    
                        properties:&nbsp;                                                                                                                                                                                                                      
                            {                                                                                                                                                                                                                                  
                                "AccessKey" : xml_hd.Chave                                                                                                                                                                                                     
                            }                                                                                                                                                                                                                                  
                    }                                                                                                                                                                                                                                          
                );                                                                                                                                                                                                                                             
                efdModel.submitChanges(                                                                                                                                                                                                                        
                    {                                                                                                                                                                                                                                          
                        success: _fnSuccess.bind(this), //bind do this para referenciar no callback                                                                                                                                                            
                        error: _fnError.bind(this)&nbsp;                                                                                                                                                                                                       
                    }                                                                                                                                                                                                                                          
                );                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
                function _fnSuccess(oResponse) {                                                                                                                                                                                                               
                    let resp = JSON.parse(oResponse.__batchResponses[0].__changeResponses[0].headers['sap-message']);                                                                                                                                          
                                                                                                                                                                                                                                                               
                    let aMsgs = _msgsTable(resp);                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                    //result                                                                                                                                                                                                                                   
                    //check if it was successful                                                                                                                                                                                                               
                    if (aMsgs) {                                                                                                                                                                                                                               
                        let docnum = _getDocnum(aMsgs);                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                        if (docnum) { //successful                                                                                                                                                                                                             
                            //send the docnum to the RAP backend                                                                                                                                                                                               
                            //set the parameters                                                                                                                                                                                                               
                            var sPath = oView.getBindingContext().getPath();                                                                                                                                                                                   
                            var xml_hd = mainModel.getProperty(sPath);                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                            var oUrlParams = {                                                                                                                                                                                                                 
                                "Chave": xml_hd.Chave,                                                                                                                                                                                                         
                                "Docnum": docnum                                                                                                                                                                                                               
                            }                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                            mainModel.callFunction(                                                                                                                                                                                                            
                                "/NfWriteAction",                                                                                                                                                                                                              
                                {                                                                                                                                                                                                                              
                                    method:"POST",&nbsp;                                                                                                                                                                                                       
                                    urlParameters: oUrlParams,&nbsp;                                                                                                                                                                                           
                                    success: _fnSuccess2.bind(this),&nbsp;                                                                                                                                                                                     
                                    error: _fnError2.bind(this)                                                                                                                                                                                                
                                }                                                                                                                                                                                                                              
                            );                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                            function _fnSuccess2(ctx) {                                                                                                                                                                                                        
                                oView.setBusy(false);                                                                                                                                                                                                          
                                this.refreshIt();                                                                                                                                                                                                              
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                       
                                MessageToast.show(                                                                                                                                                                                                             
                                        this.getI18nText("document")                                                                                                                                                                                           
                                    +   " "                                                                                                                                                                                                                    
                                    +   docnum                                                                                                                                                                                                                 
                                    +   " "                                                                                                                                                                                                                    
                                    +   this.getI18nText("success")                                                                                                                                                                                            
                                    +   "!"                                                                                                                                                                                                                    
                                );                                                                                                                                                                                                                             
                            }                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                            function _fnError2(ctx) {                                                                                                                                                                                                          
                                oView.setBusy(false);                                                                                                                                                                                                          
                                MessageToast.show(this.getI18nText("GeneralError"));                                                                                                                                                                           
                                debugger;                                                                                                                                                                                                                      
                            }                                                                                                                                                                                                                                  
                        } else {                                                                                                                                                                                                                               
                            oView.setBusy(false);                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                            //if not successful call the messages popup                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                            // pass the result messages to the global model                                                                                                                                                                                    
                            let oModel = this.getGlobalModel();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                            
                            var oGlobalModelData = oModel.getData();                                                                                                                                                                                           
                            oGlobalModelData.NfWriteMsgs = aMsgs;                                                                                                                                                                                              
                            oModel.setData(oGlobalModelData);                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                            //show the result                                                                                                                                                                                                                  
                            NfWriteMsgs.popUp(this);                                                                                                                                                                                                           
                        } //not successful                                                                                                                                                                                                                     
                    } //aMsgs                                                                                                                                                                                                                                  
                } //_fnSuccess                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                function _fnError(ctx) {                                                                                                                                                                                                                       
                    oView.setBusy(false);                                                                                                                                                                                                                      
                    MessageToast.show(this.getI18nText("GeneralError"));                                                                                                                                                                                       
                    debugger;                                                                                                                                                                                                                                  
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                function _getDocnum(aMsgs) {                                                                                                                                                                                                                   
                    for (let i=0;i<aMsgs.length;i++) {                                                                                                                                                                                                         
                        if (aMsgs[i].code=="8B/161") { //success message                                                                                                                                                                                       
                            return aMsgs[i].message.split(" ")[2];&nbsp;                                                                                                                                                                                       
                        }                                                                                                                                                                                                                                      
                    }                                                                                                                                                                                                                                          
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                function _msgsTable(oResp) {                                                                                                                                                                                                                   
                    let aTab = [];                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
                    aTab.push(                                                                                                                                                                                                                                 
                        {                                                                                                                                                                                                                                      
                            code: oResp.code,                                                                                                                                                                                                                  
                            type: "E",                                                                                                                                                                                                                         
                            message: oResp.message                                                                                                                                                                                                             
                        }                                                                                                                                                                                                                                      
                    );                                                                                                                                                                                                                                         
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                       
                    for (var i=0;i<oResp.details.length;i++) {                                                                                                                                                                                                 
                        aTab.push(                                                                                                                                                                                                                             
                            {                                                                                                                                                                                                                                  
                                code: oResp.details[i].code,                                                                                                                                                                                                   
                                type: "E",                                                                                                                                                                                                                     
                                message: oResp.details[i].message                                                                                                                                                                                              
                            }                                                                                                                                                                                                                                  
                        );                                                                                                                                                                                                                                     
                    }                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                    return aTab;                                                                                                                                                                                                                               
                }                                                                                                                                                                                                                                              
            }, //onNfWrite                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
            onOkNfWriteMsgsPopup: function() {                                                                                                                                                                                                                 
                NfWriteMsgs.close(this);                                                                                                                                                                                                                       
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
            //...more functions                                                                                                                                                                                                                                
		});                                                                                                                                                                                                                                                          
	});                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               