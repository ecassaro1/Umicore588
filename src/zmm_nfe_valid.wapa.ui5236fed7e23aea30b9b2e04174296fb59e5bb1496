//Erros dos Itens                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
sap.ui.define([                                                                                                                                                                                                                                                
	'sap/ui/core/util/Export',                                                                                                                                                                                                                                    
	'sap/ui/core/util/ExportTypeCSV',                                                                                                                                                                                                                             
    'sap/ui/export/Spreadsheet',                                                                                                                                                                                                                               
	"sap/ui/model/Filter",                                                                                                                                                                                                                                        
	"sap/ui/model/FilterOperator",                                                                                                                                                                                                                                
    "sap/ui/model/json/JSONModel"                                                                                                                                                                                                                              
],	                                                                                                                                                                                                                                                            
	function (Export,ExportTypeCSV,Spreadsheet,Filter,FilterOperator,JSONModel) {                                                                                                                                                                                 
		"use strict";                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
        let API = {                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
            OC: null,                                                                                                                                                                                                                                          
            oView: null,                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
            localFull: {},                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
            Export: function (iOC,iView) {                                                                                                                                                                                                                     
                this.OC = iOC;                                                                                                                                                                                                                                 
                this.oView = iView;                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                iView.setBusy(true);                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
                this._fetchFull().then(                                                                                                                                                                                                                        
                    this._enrichIt.bind(this),  //resolve                                                                                                                                                                                                      
                    (error)=>{                  //reject                                                                                                                                                                                                       
                        debugger;                                                                                                                                                                                                                              
                    }                                                                                                                                                                                                                                          
                ).then(this._exportIt.bind(this));                                                                                                                                                                                                             
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            _fetchFull: async function() {                                                                                                                                                                                                                     
                var aLocalShort = this.OC.getModel("localShort");                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                var defaultModel = this.OC.getModel();                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                var aFilters = _buildFilters(aLocalShort);                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                //fetch the full data                                                                                                                                                                                                                          
                return new Promise(                                                                                                                                                                                                                            
                    (resolve,reject)=>{                                                                                                                                                                                                                        
                        defaultModel.read(                                                                                                                                                                                                                     
                            "/Errors",                                                                                                                                                                                                                         
                            {                                                                                                                                                                                                                                  
                                urlParameters: {                                                                                                                                                                                                               
                                    "$expand": "to_Header/to_eDoc",                                                                                                                                                                                            
                                    "$top": "100000"                                                                                                                                                                                                           
                                },                                                                                                                                                                                                                             
                                filters: aFilters,                                                                                                                                                                                                             
                                success: (oData)=>{resolve(oData)},&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                  
                                error: (error)=>{reject(error)}                                                                                                                                                                                                
                            }                                                                                                                                                                                                                                  
                        );&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                             
                    }                                                                                                                                                                                                                                          
                );                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
                function _buildFilters(aShort) {                                                                                                                                                                                                               
                    var aFilters = [];                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                    aShort.forEach((oShort)=>{                                                                                                                                                                                                                 
                        var oFilter = new Filter(                                                                                                                                                                                                              
                            "Chave",                                                                                                                                                                                                                           
                            FilterOperator.EQ,                                                                                                                                                                                                                 
                            oShort.Accesskey                                                                                                                                                                                                                   
                        );                                                                                                                                                                                                                                     
                        aFilters.push(oFilter);                                                                                                                                                                                                                
                    });                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                    var oFilter = new Filter(                                                                                                                                                                                                                  
                        "Inactive",                                                                                                                                                                                                                            
                        FilterOperator.EQ,                                                                                                                                                                                                                     
                       ''                                                                                                                                                                                                                                      
                    );                                                                                                                                                                                                                                         
                    aFilters.push(oFilter);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&+
nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                    return aFilters;                                                                                                                                                                                                                           
                }                                                                                                                                                                                                                                              
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            _enrichIt: function(oData) {                                                                                                                                                                                                                       
                var aRich = oData.results.map((to_Errors)=>{                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                    var oRich = to_Errors;                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                    //Items                                                                                                                                                                                                                                    
                    //nothing to do...                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                    return oRich;                                                                                                                                                                                                                              
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                return aRich;                                                                                                                                                                                                                                  
            },                                                                                                                                                                                                                                                 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                           
            _exportIt(oData) {                                                                                                                                                                                                                                 
                //sample do UI5                                                                                                                                                                                                                                
                // https://sapui5.hana.ondemand.com/#/entity/sap.m.Table/sample/sap.m.sample.TableExport                                                                                                                                                       
                                                                                                                                                                                                                                                               
                var oModel = new JSONModel(oData);                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
                var oExport = new Export({                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                    // Type that will be used to generate the content. Own ExportType's can be created to support other formats                                                                                                                                
                    exportType : new ExportTypeCSV({                                                                                                                                                                                                           
                        separatorChar : ";"                                                                                                                                                                                                                    
                    }),                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                    // Pass in the model created above                                                                                                                                                                                                         
                    models : oModel,                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
                    // binding information for the rows aggregation                                                                                                                                                                                            
                    rows : {                                                                                                                                                                                                                                   
                        path : "/"                                                                                                                                                                                                                             
                    },                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                    // column definitions with column name and binding info for the content                                                                                                                                                                    
                    columns : [                                                                                                                                                                                                                                
                        {                                                                                                                                                                                                                                      
                            name : "Status Validação",                                                                                                                                                                                                         
                            template : {                                                                                                                                                                                                                       
                                content : {                                                                                                                                                                                                                    
                                    parts: ["StatusValid"],                                                                                                                                                                                                    
                                    formatter : function(status) {                                                                                                                                                                                             
                                        if (!status) return;                                                                                                                                                                                                   
                                        switch(status) {                                                                                                                                                                                                       
                                            case "E": return "Erro";                                                                                                                                                                                           
                                            case "W": return "Aviso";                                                                                                                                                                                          
                                            default: return "Indefinido";                                                                                                                                                                                      
                                        }                                                                                                                                                                                                                      
                                    }                                                                                                                                                                                                                          
                                }&nbsp;                                                                                                                                                                                                                        
                            }                                                                                                                                                                                                                                  
                        },                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        {                                                                                                                                                                                                                                      
                            name : "Num.NF.",                                                                                                                                                                                                                  
                            template : {                                                                                                                                                                                                                       
                                content : {                                                                                                                                                                                                                    
                                    parts: ["NNf"],                                                                                                                                                                                                            
                                }&nbsp;                                                                                                                                                                                                                        
                            }                                                                                                                                                                                                                                  
                        },                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        {                                                                                                                                                                                                                                      
                            name : "Item XML",                                                                                                                                                                                                                 
                            template : {                                                                                                                                                                                                                       
                                content : {                                                                                                                                                                                                                    
                                    parts: ["ItemXml"],                                                                                                                                                                                                        
                                }&nbsp;                                                                                                                                                                                                                        
                            }                                                                                                                                                                                                                                  
                        },                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        {                                                                                                                                                                                                                                      
                            name : "Nº Pedido",                                                                                                                                                                                                                
                            template : {                                                                                                                                                                                                                       
                                content : {                                                                                                                                                                                                                    
                                    parts: ["Pedido"],                                                                                                                                                                                                         
                                }&nbsp;                                                                                                                                                                                                                        
                            }                                                                                                                                                                                                                                  
                        },&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                     
                                                                                                                                                                                                                                                               
                        {                                                                                                                                                                                                                                      
                            name : "Item do Pedido",                                                                                                                                                                                                           
                            template : {                                                                                                                                                                                                                       
                                content : {                                                                                                                                                                                                                    
                                    parts: ["ItemPedido"],                                                                                                                                                                                                     
                                }&nbsp;                                                                                                                                                                                                                        
                            }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                        
                        },                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        {                                                                                                                                                                                                                                      
                            name : "Descrição do Erro",                                                                                                                                                                                                        
                            template : {                                                                                                                                                                                                                       
                                content : {                                                                                                                                                                                                                    
                                    parts: ["Texto"],                                                                                                                                                                                                          
                                }&nbsp;                                                                                                                                                                                                                        
                            }&nbsp;&nbsp;                                                                                                                                                                                                                      
                        },                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        {                                                                                                                                                                                                                                      
                            name : "Valor XML",                                                                                                                                                                                                                
                            template : {                                                                                                                                                                                                                       
                                content : {                                                                                                                                                                                                                    
                                    parts : ["ValorXml"],                                                                                                                                                                                                      
                                    formatter : function(valorXml) {                                                                                                                                                                                           
                                        if (!valorXml) return;                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                                        valorXml = "'"+valorXml.trim()+"'";                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                                        return valorXml;                                                                                                                                                                                                       
                                    }                                                                                                                                                                                                                          
                                }&nbsp;                                                                                                                                                                                                                        
                            }&nbsp;&nbsp;                                                                                                                                                                                                                      
                        },                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        {                                                                                                                                                                                                                                      
                            name : "Valor SAP",                                                                                                                                                                                                                
                            template : {                                                                                                                                                                                                                       
                                content : {                                                                                                                                                                                                                    
                                    parts : ["ValorSap"],                                                                                                                                                                                                      
                                    formatter : function(valorSap) {                                                                                                                                                                                           
                                        if (!valorSap) return;                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                                        valorSap = "'"+valorSap.trim()+"'";                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                                        return valorSap;                                                                                                                                                                                                       
                                    }                                                                                                                                                                                                                          
                                }&nbsp;                                                                                                                                                                                                                        
                            }&nbsp;&nbsp;                                                                                                                                                                                                                      
                        }                                                                                                                                                                                                                                      
                    ]                                                                                                                                                                                                                                          
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                // download exported file                                                                                                                                                                                                                      
                oExport.saveFile().catch(function(oError) {                                                                                                                                                                                                    
                    MessageBox.error(                                                                                                                                                                                                                          
                        //this.getView().getModel("i18n").getResourceBundle().getText("DataExportError")                                                                                                                                                       
                        "Error when downloading data. Browser might not be supported!"                                                                                                                                                                         
                        +"\n\n"&nbsp;                                                                                                                                                                                                                          
                        + oError);                                                                                                                                                                                                                             
                }).then(function() {                                                                                                                                                                                                                           
                    oExport.destroy();                                                                                                                                                                                                                         
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                this.oView.setBusy(false);                                                                                                                                                                                                                     
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
			getI18nText: function(key) {                                                                                                                                                                                                                                
				return this.OC.getModel("i18n").getResourceBundle().getText(key);                                                                                                                                                                                          
			}                                                                                                                                                                                                                                                           
        } // API                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
        return API.Export.bind(API);                                                                                                                                                                                                                           
    }                                                                                                                                                                                                                                                          
)                                                                                                                                                                                                                                                              