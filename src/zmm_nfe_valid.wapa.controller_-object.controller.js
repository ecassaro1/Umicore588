sap.ui.define(["sap/m/MessageBox","sap/m/MessageToast","sap/ui/model/resource/ResourceModel","umicore/mm/nfevalid/zmmnfevalid/controller/Base.controller","umicore/mm/nfevalid/zmmnfevalid/controller/Message","umicore/mm/nfevalid/zmmnfevalid/controller/Div+
ergences","umicore/mm/nfevalid/zmmnfevalid/controller/DivergencesShow","umicore/mm/nfevalid/zmmnfevalid/controller/ContentViewer","umicore/mm/nfevalid/zmmnfevalid/model/formatter","umicore/mm/nfevalid/zmmnfevalid/controller/NfWriteMsgs"],function(e,t,s,i+
,n,r,a,o,l,g){"use strict";return i.extend("umicore.mm.nfevalid.zmmnfevalid.controller.Object",{formatter:l,oListView:null,action:null,selItem:null,oView:null,onInit:function(){var e=this.getRouter();e.getRoute("RouteObject").attachMatched(this.onRouteMa+
tched,this);this.getView().setModel(this.getGlobalModel(),"global");var t=this.getGlobalModel().getData();this.oListView=t.oListView;var i=new sap.ui.model.json.JSONModel({errorsTitle:"",oView:this.getView()});this.getView().setModel(i,"local");var n=new+
 s({bundleName:"umicore.mm.nfevalid.zmmnfevalid.i18n.i18n"});this.getView().setModel(n,"i18n")},onRouteMatched:function(e){this.ctxSetup()},ctxSetupForTest:function(){console.log("Teste mode");this.bindIt(this.getView(),"/XML('352202325313640001945500100+
00009601863159467')")},ctxSetup:function(){this.getView().setBusy(true);var e=this.getGlobalModel().getData();if(!e.listRow){this.ctxSetupForTest();return}var t=e.listRow.oData.Accesskey;var s=e.listRow.sPath;s=s.replace("eDoc","XML");var i=this;n(this.g+
etView().getModel(),s).then(function(e){if(e){i.bindIt(i.getView(),s)}else{i._create(i.getView().getModel(),t).then(function(e){if(!e){i.onNavBack()}i.bindIt(i.getView(),s)})}});this.getView().byId("itemDetails").setVisible(false);function n(e,t){var s=f+
alse;return new Promise(function(i,n){e.read(t,{success:function(){s=true;i(s)},error:function(){s=false;i(s)}})})}},_create:function(e,t){return new Promise(function(s,i){e.createEntry("XML",{properties:{Chave:t}});e.submitChanges({success:function(){s(+
true)},error:function(){debugger;s(false)}})})},bindIt:function(e,t){this.thePath=t;var s=e;e.bindElement({path:t,parameters:{expand:"to_eDoc,to_Items,to_Cods,to_LastLogH,to_Errors,to_ObsH,"+"to_Items/to_Errors,"+"to_Items/to_Errors/to_Item,"+"to_Items/t+
o_eDocIt,"+"to_Items/to_LastLog,"+"to_Items/to_Obs,"+"to_Items/to_eDoc,"+"to_Items/to_Header,"+"to_Items/to_Header/to_eDoc"},events:{change:i.bind(this),dataRequested:function(e){s.setBusy(true)},dataReceived:i.bind(this)}});this.setErrorsTable(this.theP+
ath,this.getI18nText("ErrorsAll"));function i(e){s.setBusy(false)}},refreshIt:function(){var e=this.getView().getModel();e.refresh();if(this.oListView)this.oListView.listRefresh()},onValidate:function(){var e=this.getView();var s=e.getModel();var i=e.get+
BindingContext().getPath();var n=s.getProperty(i);var r={Chave:n.Chave};e.setBusy(true);s.callFunction("/ValidateAction",{method:"POST",urlParameters:r,success:a.bind(this),error:o.bind(this)});function a(){this.refreshIt();t.show(this.getI18nText("Valid+
ationDone"))}function o(){debugger;e.setBusy(false)}},_checkSelItems:function(){var e=this.getView().byId("itemsTable").getSelectedItems();return e.length>0},_getSelItemData:function(){var e=this.getView().byId("itemsTable").getSelectedItems();var t=e[0]+
.getBindingContextPath();var s=this.getView().getModel().getProperty(t);return s},onReleaseOld:function(){if(!this._checkSelItems())return;var t=this._getSelItemData();if(t.Status=="1"){e.error(this.getI18nText("ReleasedItem"));return}this.action="L";n.p+
opUp(this)},onRelease:function(){var t=this.getView();var s=t.getModel();var i=t.getBindingContext().getPath();var r=s.getProperty(i);if(r.Status=="1"){e.error(this.getI18nText("ReleasedNFe"));return}this.action="L";n.popUp(this)},onReject:function(){var+
 t=this.getView();var s=t.getModel();var i=t.getBindingContext().getPath();var r=s.getProperty(i);if(r.Status=="9"){e.error(this.getI18nText("RejectNFe"));return}this.action="J";n.popUp(this)},onUndo:function(){var t=this.getView();var s=t.getModel();var+
 i=t.getBindingContext().getPath();var r=s.getProperty(i);if(r.Status=="3"){e.error(this.getI18nText("UndoneNFe"));return}this.action="U";n.popUp(this)},onCancMessagePopup:function(){n.close(this)},onOkMessagePopupOld:function(){var e=this.getView();var +
t=this.getGlobalModel();var s=t.getData();var i=s.Message;var r=e.getModel();var a=e.byId("itemsTable").getSelectedItems();a.forEach(t=>{var s=t.getBindingContextPath();var a=r.getProperty(s);var o={Chave:a.Chave,Id:a.Id,Action:this.action,Message:i};e.s+
etBusy(true);r.callFunction("/StatusChangeAction",{method:"POST",urlParameters:o,success:l.bind(this),error:g.bind(this)});function l(t){e.setBusy(false);n.close(this);this.refreshIt()}function g(t){e.setBusy(false);n.close(this);debugger}})},onOkMessage+
Popup:function(){var e=this.getView();var t=this.getGlobalModel();var s=t.getData();var i=s.Message;var r=e.getModel();var a=e.getBindingContext().getPath();var o=r.getProperty(a);var l={Chave:o.Chave,Action:this.action,Message:i};e.setBusy(true);r.callF+
unction("/StatusChangeAction",{method:"POST",urlParameters:l,success:g.bind(this),error:h.bind(this)});function g(t){e.setBusy(false);n.close(this);this.refreshIt()}function h(t){e.setBusy(false);n.close(this);debugger}},onArchiveUnarchive:function(){var+
 e=this.getView().getModel().getProperty(this.getView().getBindingContext().getPath());switch(e.Archive){case"X":this.unarchive(e);break;case"":this.archive(e);break}},archive:function(t){if(!(t.Status=="1"||t.Status=="9")||t.StatusValid=="S"){e.error(th+
is.getI18nText("IncorrectStatus"));return}this.fileActionCall("F")},unarchive:function(e){this.fileActionCall("U","dummy")},onDivergences:function(){r.popUp(this)},onCancDivergencesPopup:function(){r.close(this)},onOkDivergencesPopup:function(){var e=thi+
s.getView();var t=sap.ui.getCore().byId("cadDivList").getSelectedContexts();var s="";t.forEach(e=>{if(s){s+=";"}s+=e.getProperty("CodDiv")});this.divActionCall(s)},onDivShow:function(){a.popUp(this)},onOkDivergencesShowPopup:function(){a.close(this)},fil+
eActionCall(e){var t=this.getView();var s=t.getModel();var i=t.getBindingContext().getPath();var n=s.getProperty(i);var a={Chave:n.Chave,Action:e};t.setBusy(true);s.callFunction("/FileAction",{method:"POST",urlParameters:a,success:o.bind(this),error:l.bi+
nd(this)});function o(e){t.setBusy(false);r.close(this);this.refreshIt()}function l(e){t.setBusy(false);r.close(this);debugger}},divActionCall(e){var t=this.getView();var s=t.getModel();var i=t.getBindingContext().getPath();var n=s.getProperty(i);var a={+
Chave:n.Chave,Message:e};t.setBusy(true);s.callFunction("/DivAction",{method:"POST",urlParameters:a,success:o.bind(this),error:l.bind(this)});function o(e){t.setBusy(false);r.close(this);this.refreshIt()}function l(e){t.setBusy(false);r.close(this);debug+
ger}},onXml:function(){var e=this.getView().getBindingContext().getPath();var t=this.getView().getModel().getProperty(e);var s=t.XmlStr;s=s.replace(/&amp;/g," ").replace(/&lt;/g,"|").replace(/&gt;/g,"|");o.popUp(this,s)},onRefXml:function(){var e=this.ge+
tView().getBindingContext().getPath();var t=this.getView().getModel().getProperty(e);o.popUp(this,t.RefXmlStr)},onOkContentViewer:function(){o.close(this)},onItemPressed:function(e){var t,s,i;t=e.getSource();s=t.getBindingContext();i=e.getSource().getBin+
dingContext().getPath();this.selItem=s;this.getView().byId("itemDetails").setVisible(true);var n=this.getView().getModel("local");var r=n.getData();r.itemDetailsTitle="(Item: "+this.selItem.getProperty("Id")+")";r.selItem=this.selItem;n.setData(r);var a=+
this.getView().byId("itemDetails");a.bindElement(i);var o=this.getI18nText("Errors")+" (Item: "+this.selItem.getProperty("Id")+")";this.setErrorsTable(i,o);o=this.getI18nText("Remarks")+" (Item: "+this.selItem.getProperty("Id")+")"},setErrorsTable:functi+
on(e,t){var s=this;i(e);n(t);function i(e){var t;t=s.getView().byId("errorsTable");t.bindElement({path:e});t=s.getView().byId("errorsTableInactive");t.bindElement({path:e})}function n(e){var t=s.getView().getModel("local");var i=t.getData();i.errorsTitle+
=e;t.setData(i)}},setObsTable:function(e,t){var s=this;i(e);n(t);function i(e){var t;t=s.getView().byId("obsTable");t.bindElement({path:e});t.getBinding("items").refresh()}function n(e){var t=s.getView().getModel("local");var i=t.getData();i.obsTitle=e;t+
.setData(i)}},onXPEDChange:function(e){let t=this.getView().getModel("local");let s=t.getData();s.pendingItemChange=true;t.setData(s);return},onNItemPedChange:function(e){let t=this.getView().getModel("local");let s=t.getData();s.pendingItemChange=true;t+
.setData(s);return},onItemsPedSave:function(e){function t(e,t){for(let s=0;s<=e.length;s++){if(e[s].mBindingInfos.value&&e[s].mBindingInfos.value.binding.sPath==t){let t=e[s].mProperties.value.trim();return t}}}let s=this.getView();let i=s.getModel();let+
 n=s.byId("itemsTable");n.getItems().forEach(e=>{let s=i.getProperty(e.getBindingContext().getPath());let n=e.mAggregations.cells;let r=t(n,"XPed");if(r!==s.XPed.toString()){i.setProperty(e.getBindingContext().getPath()+"/XPed",r.toString())}let a=t(n,"N+
ItemPed");if(a!==s.NItemPed.toString()){i.setProperty(e.getBindingContext().getPath()+"/NItemPed",parseInt(a))}});if(i.hasPendingChanges()){i.submitChanges({success:o.bind(this),error:l.bind(this)})}let r=this.getView().getModel("local");let a=r.getData(+
);a.pendingItemChange=false;r.setData(a);function o(e){s.setBusy(false);this.refreshIt()}function l(e){s.setBusy(false);debugger}},onPinChange:function(e){var s=e.getParameters().newValue;if(!s){s=this.getView().byId("pin").getSelectedKey()}var i=this.ge+
tView();var n=i.getModel();var r=e.getSource().getBindingContext().getPath();var a=n.getProperty(r);var o={Chave:a.Chave,Pin:s};i.setBusy(true);n.callFunction("/PinChangeAction",{method:"POST",urlParameters:o,success:l.bind(this),error:g.bind(this)});fun+
ction l(e){i.setBusy(false);t.show("Pin has been changed.")}function g(e){i.setBusy(false);debugger}},onActReqChange:function(e){var s=e.getParameters().newValue;if(!s){s=this.getView().byId("actionRequired").getSelectedKey()}var i=this.getView();var n=i+
.getModel();var r=e.getSource().getBindingContext().getPath();var a=n.getProperty(r);var o={Chave:a.Chave,ActReq:s};i.setBusy(true);n.callFunction("/ActReqChangeAction",{method:"POST",urlParameters:o,success:l.bind(this),error:g.bind(this)});function l(e+
){i.setBusy(false);this.refreshIt();t.show(this.getI18nText("ActReqChanged"))}function g(e){i.setBusy(false);debugger}},onAllItems:function(){var e=this.getView().getModel("local");var t=e.getData();this.selItem=null;t.selItem=null;e.setData(t);this.setE+
rrorsTable(this.thePath,this.getI18nText("ErrorsAll"))},onSendObs:function(){if(!this.selItem)return;var e=this.getView();var t=e.getModel();var s=this.selItem.getPath();var i=t.getProperty(s);var n=this.getView().getModel("local");var r=n.getData();var +
a=r.Obs;r.Obs="";n.setData(r);var o={Chave:i.Chave,Id:i.Id,Obs:a};e.setBusy(true);t.callFunction("/ObsSendAction",{method:"POST",urlParameters:o,success:l.bind(this),error:g.bind(this)});function l(t){e.setBusy(false);this.refreshIt()}function g(t){e.set+
Busy(false);debugger}},onSendObsH:function(){var e=this.getView();var t=e.getModel();var s=e.getBindingContext().getPath();var i=t.getProperty(s);var n=this.getView().getModel("local");var r=n.getData();var a=r.Obs;if(!a)return;r.Obs="";n.setData(r);var +
o={Chave:i.Chave,Obs:a};e.setBusy(true);t.callFunction("/ObsHSendAction",{method:"POST",urlParameters:o,success:l.bind(this),error:g.bind(this)});function l(t){e.setBusy(false);this.refreshIt()}function g(t){e.setBusy(false);debugger}},onNfWrite_old:func+
tion(){var e=this.getView();var s=e.getModel();var i=e.getBindingContext().getPath();var n=s.getProperty(i);var r={Chave:n.Chave};e.setBusy(true);s.callFunction("/NfWriteAction",{method:"POST",urlParameters:r,success:a.bind(this),error:o.bind(this)});fun+
ction a(s){e.setBusy(false);this.refreshIt();if(s&&s.results){let e=l(s.results);if(e){t.show(this.getI18nText("document")+" "+e+" "+this.getI18nText("success")+"!")}else{let e=this.getGlobalModel();var i=e.getData();i.NfWriteMsgs=s.results;e.setData(i);+
g.popUp(this)}}}function o(t){e.setBusy(false);debugger}function l(e){for(let t=0;t<e.length;t++){if(e[t].Docnum!=""){return e[t].Docnum}}}},onNfWrite:function(){var e=this.getView();var s=e.getModel();var i=e.getModel("efdNfWriter");var n=e.getBindingCo+
ntext().getPath();var r=s.getProperty(n);var a={AccessKey:r.Chave};e.setBusy(true);i.createEntry("NFESet",{properties:{AccessKey:r.Chave}});i.submitChanges({success:o.bind(this),error:l.bind(this)});function o(i){let n=JSON.parse(i.__batchResponses[0].__+
changeResponses[0].headers["sap-message"]);let r=c(n);if(r){let d=h(r);if(d){var a=e.getBindingContext().getPath();var o=s.getProperty(a);var l={Chave:o.Chave,Docnum:d};s.callFunction("/NfWriteAction",{method:"POST",urlParameters:l,success:f.bind(this),e+
rror:v.bind(this)});function f(s){e.setBusy(false);this.refreshIt();t.show(this.getI18nText("document")+" "+d+" "+this.getI18nText("success")+"!")}function v(s){e.setBusy(false);t.show(this.getI18nText("GeneralError"));debugger}}else{e.setBusy(false);let+
 m=this.getGlobalModel();var u=m.getData();u.NfWriteMsgs=r;m.setData(u);g.popUp(this)}}}function l(s){e.setBusy(false);t.show(this.getI18nText("GeneralError"));debugger}function h(e){for(let t=0;t<e.length;t++){if(e[t].code=="8B/161"){return e[t].message+
.split(" ")[2]}}}function c(e){let t=[];t.push({code:e.code,type:"E",message:e.message});for(var s=0;s<e.details.length;s++){t.push({code:e.details[s].code,type:"E",message:e.details[s].message})}return t}},onOkNfWriteMsgsPopup:function(){g.close(this)}}+
)});                                                                                                                                                                                                                                                           