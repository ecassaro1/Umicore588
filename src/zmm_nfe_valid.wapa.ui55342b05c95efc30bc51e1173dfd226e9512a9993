sap.ui.define([                                                                                                                                                                                                                                                
	"umicore/mm/nfevalid/zmmnfevalid/controller/Base.controller",                                                                                                                                                                                                 
	"sap/ui/model/json/JSONModel",                                                                                                                                                                                                                                
	"sap/ui/model/Filter",                                                                                                                                                                                                                                        
	"sap/ui/model/FilterOperator",                                                                                                                                                                                                                                
    "umicore/mm/nfevalid/zmmnfevalid/model/formatter",                                                                                                                                                                                                         
	'sap/ui/core/Fragment',                                                                                                                                                                                                                                       
	'sap/m/Token',                                                                                                                                                                                                                                                
	'sap/m/SearchField',                                                                                                                                                                                                                                          
	"sap/ui/model/resource/ResourceModel",                                                                                                                                                                                                                        
	"umicore/mm/nfevalid/zmmnfevalid/controller/Excel1",                                                                                                                                                                                                          
	"umicore/mm/nfevalid/zmmnfevalid/controller/Excel2",                                                                                                                                                                                                          
	"umicore/mm/nfevalid/zmmnfevalid/controller/Excel3",                                                                                                                                                                                                          
	"umicore/mm/nfevalid/zmmnfevalid/controller/Excel4"	                                                                                                                                                                                                          
],                                                                                                                                                                                                                                                             
	function (Controller,JSONModel,Filter,FilterOperator,formatter,Fragment,Token,SearchField,ResourceModel,Excel1,Excel2,Excel3,Excel4) {                                                                                                                        
		"use strict";                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
		return Controller.extend("umicore.mm.nfevalid.zmmnfevalid.controller.List", {                                                                                                                                                                                
			formatter: formatter,                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
			oView: null,                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
			onInit: function () {                                                                                                                                                                                                                                       
				this.oView = this.getView();                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
				//this.sayHello("from List.view!");                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
				// set i18n model on view                                                                                                                                                                                                                                  
				var i18nModel = new ResourceModel({                                                                                                                                                                                                                        
					bundleName: "umicore.mm.nfevalid.zmmnfevalid.i18n.i18n"                                                                                                                                                                                                   
				});                                                                                                                                                                                                                                                        
				this.getView().setModel(i18nModel, "i18n");                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
				// user filter                                                                                                                                                                                                                                             
				this._setUserSHCols();&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                                   
				this._oInput = this.getView().byId("ekkoUser");&nbsp;                                                                                                                                                                                                      
			},                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
			onSfbInitialized: function(oHndl) {                                                                                                                                                                                                                         
				var sfb = oHndl.getSource();                                                                                                                                                                                                                               
				var compayCodeControl = sfb.getControlByKey("CompanyCode");                                                                                                                                                                                                
				this.disable(this.getView(),compayCodeControl);	                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
				//oData package size                                                                                                                                                                                                                                       
				this.getView().getModel().setSizeLimit(100000);                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
				//triggers first search automatically                                                                                                                                                                                                                      
				sfb.search();			                                                                                                                                                                                                                                           
			},                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
			onSearch: function(oHndl) {                                                                                                                                                                                                                                 
				this.getView().setBusy(true);                                                                                                                                                                                                                              
				var oSfb = oHndl.getSource();                                                                                                                                                                                                                              
				this.doSearch(oSfb);                                                                                                                                                                                                                                       
			},                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
			doSearch: function(oSfb) {                                                                                                                                                                                                                                  
				var aFilters = oSfb.getFilters();                                                                                                                                                                                                                          
				var oModel = this.getView().getModel();                                                                                                                                                                                                                    
				oModel.read(                                                                                                                                                                                                                                               
					"/eDoc",                                                                                                                                                                                                                                                  
					{                                                                                                                                                                                                                                                         
						filters: aFilters,                                                                                                                                                                                                                                       
						urlParameters: "top=3000",                                                                                                                                                                                                                               
						success: _success.bind(this),                                                                                                                                                                                                                            
						error: function() {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                        
							this.getView().setBusy(false);                                                                                                                                                                                                                          
							debugger;                                                                                                                                                                                                                                               
						}                                                                                                                                                                                                                                                        
					}                                                                                                                                                                                                                                                         
				);      			                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
				function _success(oHndl) {                                                                                                                                                                                                                                 
					this.eDocJsonFill(oHndl.results);                                                                                                                                                                                                                         
					this.getView().setBusy(false);                                                                                                                                                                                                                            
				}                                                                                                                                                                                                                                                          
			},                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
			getFilters: function() {                                                                                                                                                                                                                                    
				var aFilters = [];                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
				var ekkoUser = this.getView().byId("ekkoUser").getValue();                                                                                                                                                                                                 
				if (ekkoUser) {						                                                                                                                                                                                                                                      
					var oekkoUserFilter = new Filter(                                                                                                                                                                                                                         
						"EkkoUser",                                                                                                                                                                                                                                              
						FilterOperator.Contains,                                                                                                                                                                                                                                 
						ekkoUser                                                                                                                                                                                                                                                 
					);                                                                                                                                                                                                                                                        
					aFilters.push(oekkoUserFilter);                                                                                                                                                                                                                           
				}                                                                                                                                                                                                                                                          
				                                                                                                                                                                                                                                                           
				var infnfeEmitCnpj = this.getView().byId("infnfeEmitCnpj").getValue();                                                                                                                                                                                     
				if (infnfeEmitCnpj) {						                                                                                                                                                                                                                                
					var oinfnfeEmitCnpjFilter = new Filter(                                                                                                                                                                                                                   
						"InfnfeEmitCnpj",                                                                                                                                                                                                                                        
						FilterOperator.EQ,                                                                                                                                                                                                                                       
						this.cnpjUnmask(infnfeEmitCnpj)                                                                                                                                                                                                                          
					);                                                                                                                                                                                                                                                        
					aFilters.push(oinfnfeEmitCnpjFilter);                                                                                                                                                                                                                     
				}				                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
				return aFilters;                                                                                                                                                                                                                                           
			},                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
			eDocJsonFill: function(aResults) {                                                                                                                                                                                                                          
				//copy the data                                                                                                                                                                                                                                            
				var eDocJsonData = {                                                                                                                                                                                                                                       
					eDocJson: aResults                                                                                                                                                                                                                                        
				}                                                                                                                                                                                                                                                          
				var eDocJsonModel = new JSONModel(eDocJsonData);                                                                                                                                                                                                           
				this.getView().setModel(eDocJsonModel,"local");                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
				let aFilters = this.getFilters();                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
				this.byId("baseTable").getBinding("items").filter(aFilters);                                                                                                                                                                                               
			},                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
			listRefresh: function() {		                                                                                                                                                                                                                                 
				var oSfb = this.getView().byId("smartFilterBar");                                                                                                                                                                                                          
				this.doSearch(oSfb);                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
				//this.getView().byId("baseTable").getBinding("items").refresh();&nbsp;                                                                                                                                                                                    
			},                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
			onListItemPressed: function(oEvent) {                                                                                                                                                                                                                       
				var oSrc = oEvent.getSource();                                                                                                                                                                                                                             
				var sPath = oSrc.getBindingContextPath();                                                                                                                                                                                                                  
				var oModel = this.getView().getModel("local");                                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
				//lets navigate, but not before we get the full row data                                                                                                                                                                                                   
				var oEntry = oModel.getProperty(sPath);                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
				if (oEntry.StatusValid=="C") {                                                                                                                                                                                                                             
					return;                                                                                                                                                                                                                                                   
				}                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
				// guardar a chave num local json model.                                                                                                                                                                                                                   
				var globalModel = this.getGlobalModel();                                                                                                                                                                                                                   
				var globalModelData = globalModel.getData();                                                                                                                                                                                                               
				globalModelData.listRow = {		                                                                                                                                                                                                                              
					sPath: "/eDoc('"+oEntry.Accesskey+"')",			                                                                                                                                                                                                                
					oData: oEntry                                                                                                                                                                                                                                             
				};                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
				//keed this controller reference for the Object.controller                                                                                                                                                                                                 
				globalModelData.oListView = this;                                                                                                                                                                                                                          
				globalModel.setData(globalModelData);                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
				//navigate                                                                                                                                                                                                                                                 
				this.getRouter().navTo("RouteObject",{"object":""});                                                                                                                                                                                                       
			}, //onListItemPressed                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
            _setUserSHCols: function() {                                                                                                                                                                                                                       
                this.oColModel =                                                                                                                                                                                                                               
                    new JSONModel(&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                       
                        {                                                                                                                                                                                                                                      
                            "cols": [                                                                                                                                                                                                                          
                                {                                                                                                                                                                                                                              
                                    "label": this.getI18nText("UserKey"),                                                                                                                                                                                      
                                    "template": "BName"                                                                                                                                                                                                        
                                },                                                                                                                                                                                                                             
                                {                                                                                                                                                                                                                              
                                    "label": this.getI18nText("UserName"),                                                                                                                                                                                     
                                    "template": "NameText"                                                                                                                                                                                                     
                                }                                                                                                                                                                                                                              
                            ]                                                                                                                                                                                                                                  
                        }                                                                                                                                                                                                                                      
                    );&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                               
            },&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
			onUserValueHelpRequested: function() {                                                                                                                                                                                                                      
				var aCols = this.oColModel.getData().cols;                                                                                                                                                                                                                 
				this._oBasicSearchField = new SearchField();                                                                                                                                                                                                               
	                                                                                                                                                                                                                                                              
				Fragment.load({                                                                                                                                                                                                                                            
					name: "umicore.mm.nfevalid.zmmnfevalid.view.UserValueHelp",                                                                                                                                                                                               
					controller: this                                                                                                                                                                                                                                          
				}).then(function name(oFragment) {                                                                                                                                                                                                                         
					this._oValueHelpDialog = oFragment;                                                                                                                                                                                                                       
					this.getView().addDependent(this._oValueHelpDialog);                                                                                                                                                                                                      
	                                                                                                                                                                                                                                                              
					var oFilterBar = this._oValueHelpDialog.getFilterBar();                                                                                                                                                                                                   
					oFilterBar.setFilterBarExpanded(false);                                                                                                                                                                                                                   
					oFilterBar.setBasicSearch(this._oBasicSearchField);                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
					this._oValueHelpDialog.getTableAsync().then(function (oTable) {                                                                                                                                                                                           
						oTable.setModel(this.oProductsModel);                                                                                                                                                                                                                    
						oTable.setModel(this.oColModel, "columns");                                                                                                                                                                                                              
	                                                                                                                                                                                                                                                              
						if (oTable.bindRows) {                                                                                                                                                                                                                                   
							oTable.bindAggregation("rows", "/User");                                                                                                                                                                                                                
						}                                                                                                                                                                                                                                                        
	                                                                                                                                                                                                                                                              
						if (oTable.bindItems) {                                                                                                                                                                                                                                  
							oTable.bindAggregation("items", "/User", function () {                                                                                                                                                                                                  
								return new ColumnListItem({                                                                                                                                                                                                                            
									cells: aCols.map(function (column) {                                                                                                                                                                                                                  
										return new Label({ text: "{" + column.template + "}" });                                                                                                                                                                                             
									})                                                                                                                                                                                                                                                    
								});                                                                                                                                                                                                                                                    
							});                                                                                                                                                                                                                                                     
						}                                                                                                                                                                                                                                                        
	                                                                                                                                                                                                                                                              
						this._oValueHelpDialog.update();                                                                                                                                                                                                                         
					}.bind(this));                                                                                                                                                                                                                                            
	                                                                                                                                                                                                                                                              
					var oToken = new Token();                                                                                                                                                                                                                                 
					oToken.setKey(this._oInput.getSelectedKey());                                                                                                                                                                                                             
					oToken.setText(this._oInput.getValue());                                                                                                                                                                                                                  
					this._oValueHelpDialog.setTokens([oToken]);                                                                                                                                                                                                               
					this._oValueHelpDialog.open();                                                                                                                                                                                                                            
				}.bind(this));                                                                                                                                                                                                                                             
	                                                                                                                                                                                                                                                              
			},                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
			onFilterBarSearch: function (oEvent) {                                                                                                                                                                                                                      
				var sSearchQuery = this._oBasicSearchField.getValue(),                                                                                                                                                                                                     
					aSelectionSet = oEvent.getParameter("selectionSet");                                                                                                                                                                                                      
				var aFilters = aSelectionSet.reduce(function (aResult, oControl) {                                                                                                                                                                                         
					if (oControl.getValue()) {                                                                                                                                                                                                                                
						aResult.push(new Filter({                                                                                                                                                                                                                                
							path: oControl.getName(),                                                                                                                                                                                                                               
							operator: FilterOperator.Contains,                                                                                                                                                                                                                      
							value1: oControl.getValue()                                                                                                                                                                                                                             
						}));                                                                                                                                                                                                                                                     
					}                                                                                                                                                                                                                                                         
	                                                                                                                                                                                                                                                              
					return aResult;                                                                                                                                                                                                                                           
				}, []);                                                                                                                                                                                                                                                    
	                                                                                                                                                                                                                                                              
				aFilters.push(new Filter({                                                                                                                                                                                                                                 
					filters: [                                                                                                                                                                                                                                                
						new Filter({ path: "BName", operator: FilterOperator.Contains, value1: sSearchQuery }),                                                                                                                                                                  
						new Filter({ path: "NameText", operator: FilterOperator.Contains, value1: sSearchQuery })                                                                                                                                                                
					],                                                                                                                                                                                                                                                        
					and: false                                                                                                                                                                                                                                                
				}));                                                                                                                                                                                                                                                       
	                                                                                                                                                                                                                                                              
				this._filterTable(new Filter({                                                                                                                                                                                                                             
					filters: aFilters,                                                                                                                                                                                                                                        
					and: true                                                                                                                                                                                                                                                 
				}));                                                                                                                                                                                                                                                       
			},                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
			_filterTable: function (oFilter) {                                                                                                                                                                                                                          
				var oValueHelpDialog = this._oValueHelpDialog;                                                                                                                                                                                                             
	                                                                                                                                                                                                                                                              
				oValueHelpDialog.getTableAsync().then(function (oTable) {                                                                                                                                                                                                  
					if (oTable.bindRows) {                                                                                                                                                                                                                                    
						oTable.getBinding("rows").filter(oFilter);                                                                                                                                                                                                               
					}                                                                                                                                                                                                                                                         
	                                                                                                                                                                                                                                                              
					if (oTable.bindItems) {                                                                                                                                                                                                                                   
						oTable.getBinding("items").filter(oFilter);                                                                                                                                                                                                              
					}                                                                                                                                                                                                                                                         
	                                                                                                                                                                                                                                                              
					oValueHelpDialog.update();                                                                                                                                                                                                                                
				});                                                                                                                                                                                                                                                        
			},                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
			onUserValueHelpOkPress: function (oEvent) {                                                                                                                                                                                                                 
				var aTokens = oEvent.getParameter("tokens");                                                                                                                                                                                                               
	                                                                                                                                                                                                                                                              
				if (aTokens.length > 0) {                                                                                                                                                                                                                                  
					this._oInput.setValue(aTokens[0].getKey());                                                                                                                                                                                                               
				}                                                                                                                                                                                                                                                          
				this._oValueHelpDialog.close();                                                                                                                                                                                                                            
			},                                                                                                                                                                                                                                                          
	                                                                                                                                                                                                                                                              
			onUserValueHelpCancelPress: function () {                                                                                                                                                                                                                   
				this._oValueHelpDialog.close();                                                                                                                                                                                                                            
			},                                                                                                                                                                                                                                                          
	                                                                                                                                                                                                                                                              
			onUserValueHelpAfterClose: function () {                                                                                                                                                                                                                    
				this._oValueHelpDialog.destroy();                                                                                                                                                                                                                          
			},                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
			onDataExport : function(oEvent) {                                                                                                                                                                                                                           
				var oLocalShort = this.getView().getModel("local");                                                                                                                                                                                                        
				let aLocalShort = _localShortFilter(this.getView(),oLocalShort.getData().eDocJson);                                                                                                                                                                        
				if (aLocalShort.length==0) return;                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
				var OC = this.getOwnerComponent();                                                                                                                                                                                                                         
				OC.setModel(aLocalShort,"localShort");                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
				var sSrcText = oEvent.getSource().getProperty("text");                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
				switch (sSrcText) {                                                                                                                                                                                                                                        
					case this.getI18nText("Excel1"):                                                                                                                                                                                                                          
						Excel1(OC,this.getView());                                                                                                                                                                                                                               
						break;					                                                                                                                                                                                                                                              
					case this.getI18nText("Excel2"):                                                                                                                                                                                                                          
						Excel2(OC,this.getView());                                                                                                                                                                                                                               
						break;					                                                                                                                                                                                                                                              
					case this.getI18nText("Excel3"):                                                                                                                                                                                                                          
						Excel3(OC,this.getView());                                                                                                                                                                                                                               
						break;					                                                                                                                                                                                                                                              
					case this.getI18nText("Excel4"):                                                                                                                                                                                                                          
						Excel4(OC,this.getView());                                                                                                                                                                                                                               
						break;					                                                                                                                                                                                                                                              
				}			                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
				function _localShortFilter(oView,aInLocalShort) {                                                                                                                                                                                                          
					let ekkoUser = oView.byId("ekkoUser").getValue().toUpperCase();                                                                                                                                                                                           
					let infnfeEmitCnpj = oView.byId("infnfeEmitCnpj").getValue().replace(/[\./-]/g,"");                                                                                                                                                                       
                                                                                                                                                                                                                                                               
					let aOutLocalShort = [];                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
					for (let i=0;i<aInLocalShort.length;i++) {                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
						if (ekkoUser) {                                                                                                                                                                                                                                          
							if (!aInLocalShort[i].EkkoUser.includes(ekkoUser)) {                                                                                                                                                                                                    
								continue;                                                                                                                                                                                                                                              
							}                                                                                                                                                                                                                                                       
						}                                                                                                                                                                                                                                                        
						if (infnfeEmitCnpj) {                                                                                                                                                                                                                                    
							if (aInLocalShort[i].InfnfeEmitCnpj!=infnfeEmitCnpj) {                                                                                                                                                                                                  
								continue;                                                                                                                                                                                                                                              
							}                                                                                                                                                                                                                                                       
						}                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
						aOutLocalShort.push(aInLocalShort[i]);                                                                                                                                                                                                                   
					}                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
					return aOutLocalShort;                                                                                                                                                                                                                                    
				}                                                                                                                                                                                                                                                          
			},                                                                                                                                                                                                                                                          
		});                                                                                                                                                                                                                                                          
	});                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                               